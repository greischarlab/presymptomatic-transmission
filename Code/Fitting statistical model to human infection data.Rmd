---
title: "Analyzing Human Infection Data (norovirus and SARS-CoV-2)"
author: "Kayla Zhang, Damie Pak, Megan Greischar"
date: "2026-02-26"
output:
  bookdown::pdf_document2:
    toc: no
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

Packages we use
```{r}
library(here)
library(pzfx)
library(data.table)
library(spatialEco)
library(pracma)
library(dplyr)
library(Polychrome)
library(lhs)
library(purrr)
library(tidyr)
```

### Importing/cleaning data

We use the shedding and symptom timing data that Ge *et al*., 2023 obtained 
from a norovirus study (Atmar *et al*., 2008). This data also contains 
qualitative test results for viral shedding values (positive or negative) 
falling below the qRT-PCR detection threshold. Any shedding values below the 
detection threshold for quantitative results are set to NA.
```{r, echo = TRUE}
noroData <- readRDS(here("data", "norodata.rds")) 

write.table(noroData$ftsshedding, "noroFtsData.txt")
noro.FShedData.unaggregated <- read.table("noroFtsData.txt", stringsAsFactors = F)
noro.FShedData.unaggregated <- noro.FShedData.unaggregated[, c(1, 2, 5, 6, 8)]

write.table(noroData$incubation, "noroIncubationData.txt")
noro.IncubData <- read.table("noroIncubationData.txt", stringsAsFactors = F)
noro.IncubData <- noro.IncubData[, c(1, 2, 5)]

# Get rid of viral shedding numbers below the qRT-PCR detection threshold 
# (noro.detection.threshold.2 copies /ml), as these samples represent ranges,
# not exact values
noro.detection.threshold <- 15000
noro.detection.threshold.2 <- 4e7
noro.FShedData.unaggregated[noro.FShedData.unaggregated$y_virus <= 
                              noro.detection.threshold.2,]$y_virus <- NA

# Average across viral shedding values at the same time point
aggregated_virus <- aggregate(y_virus ~ ID + days, 
                              noro.FShedData.unaggregated,
                              mean,
                              na.action=na.pass)
aggregated_virus <- aggregated_virus[order(as.numeric(substring(aggregated_virus$ID, 3, 4)),
                       aggregated_virus$days),]$y_virus

noro.FShedData <- noro.FShedData.unaggregated[
  !duplicated(noro.FShedData.unaggregated[, c(1, 3)]),]
noro.FShedData$y_virus <- aggregated_virus
```

We import the shedding and symptom timing data from Zhou *et al*., 2023, 
a SARS-CoV-2 study, as well. Data from the study are available by request from 
the authors; we do not provide them here.
```{r}
extract.incubation <- function(symp.data) {
  
  symptom.indexes <- symp.data[which(symp.data[, 2] > 0),]$ROWTITLE
  
  if (length(symptom.indexes) == 0) {
    symp.onset <- NA
    symp.end <- NA
  } else {
    symp.onset <- min(symptom.indexes) 
    
    if (max(symptom.indexes) + 1 > 14) {symp.end <- NA}
    else {symp.end <- max(symptom.indexes) + 1}
  }
  
  incub.data <- data.frame("ID" = colnames(symp.data)[2], "incubation" = symp.onset,
                           "end" = symp.end)
  
  return(incub.data)
}

sars.TShedData <- read_pzfx(here("data", "SARS-Supp-2.pzfx"), table=37)[, c(1, 20:37)]
# Correcting Throat_17's data from an accident in the pzfx file
sars.TShedData$Throat_17 <- read_pzfx(here("data", "SARS-Supp-2.pzfx"), table=2)$Throat
sars.TShedData <- melt(as.data.table(sars.TShedData), id.vars=c("Day"), 
                       variable.name = "ID", value.name = "y_virus", 
                       variable.factor = F)
colnames(sars.TShedData)[1] <- "days"

incub.indexes <- 37:54
sars.IncubData <- data.frame(do.call(rbind, 
                                     lapply(incub.indexes, 
                                            function(x) 
                                              extract.incubation(
                                                read_pzfx(here("data", "SARS-Fig-1.pzfx"), 
                                                    table=x)))))

# Participants were matched up by visually comparing viral shedding values

ID_dict_sars <- c("680539" = "Throat_10",
"673353" = "Throat_18",
"667186" = "Throat_11",
"550630" = "Throat_7",
"635495" = "Throat_1",
"666482" = "Throat_9",
"651806" = "Throat_15",
"635331" = "Throat_5",
"634105" = "Throat_2",
"635779" = "Throat_16",
"635729" = "Throat_4",
"637340" = "Throat_12",
"627506" = "Throat_6",
"666660" = "Throat_8",
"676586" = "Throat_13",
"666427" = "Throat_14",
"647785" = "Throat_3",
"674700" = "Throat_17"
)

sars.IncubData$ID <- ID_dict_sars[sars.IncubData$ID]

# Get rid of viral shedding below the detection threshold (1200 copies/ml)
sars.detection.threshold <- 1200
sars.TShedData[sars.TShedData$y_virus < sars.detection.threshold,]$y_virus <- NA
```

### Fitting statistical model to observed shedding values

To determine endpoints for model fitting, we use the first local minimum 
in the data. If such a value does not exist, we use the first value lesser than 
all subsequent shedding values. If such a value does not exist, we look for the 
first value below the detection threshold (lasting for at least a day). Lastly, 
if this value does not exist, we define the endpoint as the length of the shedding 
time series. The endpoint must occur after the first local maximum or, if there
is none, the maximum detected viral shedding value.

```{r, results='hide'}
whichLower <- function(index, vec){
  return(all(vec[(index+1):length(vec)] > vec[index]))
}

end.point <- function(data) {
  # In all criteria, endPt must be after the first local 
  # maximum or after maximum viral abundance if there is no local maximum.
  # endPt is defined as 1. the length of the full viral abundance time series
    # which is replaced by the following in order (if defined):
    # 2. the first value below the detection threshold (lasting at least a day) 
    # 3. the first value prior to the endPt defined by (2) for which 
  # all subsequent values were greater
    # 4. the first local minimum (defined as a timepoint with two greater points 
  # before and after) if such a value occurs earlier than the
       # endPt defined in (3)
  
  # 1. length of time-series
  endPt <- length(data$y_virus)
  
  localMaxTest <- sapply(3:(endPt-2), function(x) {
      left <- data$y_virus[(x-2):(x-1)]
      right <- data$y_virus[(x+1):(x+2)]
      
      all(left < data$y_virus[x]) && all(right < data$y_virus[x])
      
    })
  
  if(any(localMaxTest,na.rm=T)){
    minIndex <- min(which(localMaxTest)+2) + 1
  } else {
    minIndex <- which.max(data$y_virus) + 1
  }
  
  # 2. locate first value below detection threshold, if it exists
      # consider only values for which data stay below detection
      # threshold for at least one day
  
  runs <- rle(is.na(data$y_virus))
  endIndices <- cumsum(runs$lengths)
  startIndices <- endIndices - runs$lengths + 1
  
  missingRuns <- which(runs$values)
  
  nextIndex <- pmin(endIndices[missingRuns] + 1, length(data$days))
  gaps <- data$days[nextIndex] - 
    data$days[startIndices[missingRuns]]
  
  validMissingRuns <- missingRuns[gaps >= 1]
  
  if(length(validMissingRuns) > 0) {
    candidateStarts <- startIndices[validMissingRuns]
    candidateStarts <- candidateStarts[candidateStarts >= minIndex]
  }
  
  if(length(candidateStarts) > 0) {
    endPt <- min(candidateStarts)
  }

  # 3. check for values less than all subsequent values in detectable run
  remainingNonmissing <- which(is.finite(data$y_virus[minIndex:endPt])) + minIndex - 1
  minBeforeEnd <- sapply(seq_len(max(length(remainingNonmissing)-1, 0)), 
                         whichLower,
                         vec = data$y_virus[remainingNonmissing])

  if(any(minBeforeEnd)) {
    endPt <- min(remainingNonmissing[minBeforeEnd])
  }

  # 4. check for earlier end of infection wave
    # defined as a local minimum with two greater points on each side

  if(endPt>3 && endPt>minIndex){

    earlyLocalMinTest <- sapply(max(3, minIndex):
                                  min(length(data$y_virus)-2, (endPt-1)), 
                                function(x) {
      left <- data$y_virus[(x-2):(x-1)]
      right <- data$y_virus[(x+1):(x+2)]
      
      all(left > data$y_virus[x]) && all(right > data$y_virus[x])
      
    })
    
  if(any(earlyLocalMinTest,na.rm=T)){
    endPt <- min(which(earlyLocalMinTest)) + max(2, minIndex-1)
    }
  }

  return(endPt)
}

noro.endpoints <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       end.point(
                                                         noro.FShedData[noro.FShedData$ID == x,]))))
colnames(noro.endpoints) <- c('ID', 'endPt')

sars.endpoints <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       end.point(
                                                         sars.TShedData[sars.TShedData$ID == x,]))))
colnames(sars.endpoints) <- c('ID', 'endPt')
```

We fit a statistical model (Li & Handel, 2014, Holder & Beauchemin, 2011) to each
individual's shedding data that estimates viral load over time using the 
least squares method. There is a typo in Li & Handel, 2014 in the denominator, 
where the term exp(p4 * (t-p3)) is written as exp(-p4 * (t-p3)) (Holder & 
Beauchemin, 2011). We make the assumption that viral load is a 1-to-1 mapping to 
viral shedding. 

When model estimates incorrectly lie outside a given detection range,
we calculate the SSE of that point using the nearest detection threshold as 
the "observed" data point.

We used Latin hypercube sampling to select 1000 parameter sets within 
plausible ranges. For each individual, we then calculated SSE for each
set, using the 100 best sets (converged and lowest SSE) as starting 
guesses for the Nelder-Mead optimization. 
```{r}
generate.estimates <- function(t, p1, p2, p3, p4) {

  estimate <- (2 * p1) / (exp(-p2*(t-p3)) + exp(p4*(t-p3)))

  # set zeros to very small number to avoid log10(0)
  estimate[estimate==0] <- 1e-16

  res <- log10(estimate)
  
  return(res)

}

sse.viralLoad <- function(pars, data, detect.threshold, 
                          detect.threshold.2 = NA, optimization=T) {
  vl <- log10(data$y_virus)
  t <- data$days * 24
  
  finite.range <- 24*range(data$days[is.finite(data$y_virus)],na.rm=T)
  
  p1 <- exp(pars[1])
  p2 <- exp(pars[2])
  p3 <- exp(-exp(pars[3]))*diff(finite.range) + finite.range[1]
  p4 <- exp(pars[4])
  
  if(is.na(optimization) | optimization==F){
    # return hi resolution predicted time series
      hiResT <- seq(min(data$days[data$days > 0]) * 24, 
                   max(data$days) * 24, by=1)
      hiResEst <- generate.estimates(hiResT, p1, p2, p3, p4)
      if(is.na(optimization)){
        # return peak height, population growth rate, time of peak, decay rate
        res <- c(max(hiResEst),p2,hiResT[which.max(hiResEst)],p4)
        }
      if(!is.na(optimization) & optimization==F){
        res <- data.frame(t = hiResT, predData = hiResEst)}
    }

  if(!is.na(optimization) & optimization == T){
    estimates <- generate.estimates(t, p1, p2, p3, p4)
    
    # Punishing model estimates that incorrectly lie above the detection
    # threshold or extremely low (< 1)
    vl[which(is.na(vl) & estimates > detect.threshold)] <- detect.threshold
    vl[which(is.na(vl) & estimates < 1)] <- 1
    
    # Punishing model estimates that incorrectly lie outside the detection range of 
    # qualitative results
    vl[which(grepl('~', data$y_type) & estimates < detect.threshold)] <- detect.threshold 
    vl[which(grepl('~', data$y_type) & estimates > detect.threshold.2)] <- detect.threshold.2
    
    # Keep NA if estimates lie between two thresholds
    vl[which(grepl('~', data$y_type) & estimates < detect.threshold.2 & estimates > detect.threshold)] <- NA
    
    sse <- sum((estimates - vl)^2, na.rm=TRUE)
    
    res <- sse
    }
  
  return(res)
}

optim.params <- function(parm.guess, data, detect.threshold,
                                     detect.threshold.2 = NA) {
  
  fit <- optim(parm.guess, sse.viralLoad, data=data, detect.threshold=detect.threshold,
                 detect.threshold.2=detect.threshold.2)
  
  transformed.params <- sse.viralLoad(fit$par, data = data, optimization = NA)
  param.guess <- data.frame(ID=unique(data$ID), 
                         p1=fit$par[1],
                         p2=fit$par[2],
                         p3=fit$par[3],
                         p4=fit$par[4],
                         convergence=fit$convergence, 
                         sse=fit$value,
                         transp1=transformed.params[1],
                         transp2=transformed.params[2],
                         transp3=transformed.params[3],
                         transp4=transformed.params[4])
  
  return(param.guess)
  
}

eval.sse <- function(data, startguesses, detect.threshold, detect.threshold.2 = NA) {

  evalAtStartParms <- apply(startguesses, 1, sse.viralLoad, data = data, 
                            detect.threshold, detect.threshold.2)
  
  res <- as.data.frame(cbind(rep(data$ID[1],length(startguesses[,1])), startguesses, evalAtStartParms))
    
  colnames(res) <- c("ID", "p1", "p2", "p3", "p4", "sse")
  sseOrder <- order(res$sse)
  res <- res[sseOrder,]
  return(res)
}

minsse <- function(fits) {
  
  minsse <- min(fits$sse)
  pars <- unlist((fits[fits$sse == minsse, ])[1,])
  return(pars)
  
}

all.evals <- function(data, endpoints, startguess, detect.threshold, detect.threshold.2 = NA) {
  
  participants <- unique(data$ID)

  participantfits <- do.call(rbind,
                             lapply(participants,
                                    function(x) 
                                      eval.sse(data[data$ID==x,]
                                                    [1:(endpoints[endpoints$ID==x,]$endPt),],
                                                    startguess, detect.threshold,
                                                    detect.threshold.2)))
  
  return(participantfits)
}

all.fits <- function(data, endpoints, startguess, numFits,
                     detect.threshold, detect.threshold.2 = NA) {

  participants <- unique(data$ID)
  
  # identify parameter columns in startguess matrix
  parmColumns <- which(grepl("p", colnames(startguess)))
  
  participant.fits <- data.frame(ID=character(),
                                 p1=double(),
                                 p2=double(),
                                 p3=double(),
                                 p4=double(),
                                 convergence=integer(),
                                 sse=double(),
                                 transp1=double(),
                                 transp2=double(),
                                 transp3=double(),
                                 transp4=double())
  
  for (p in participants) {
      n_fits <- 0
      pguess <- startguess[startguess$ID == p,]
      
      for (i in 1:nrow(pguess)) {
        pg <- pguess[i,]
    
        fit <- optim.params(pg[parmColumns], 
                            data[data$ID == p,][1:(endpoints[endpoints$ID==p,]$endPt),],
                            detect.threshold, 
                            detect.threshold.2)
        
        if (fit$convergence == 0) {
          participant.fits <- rbind(participant.fits, fit)
          
          n_fits <- n_fits + 1
        }
        
        if (n_fits == numFits) {
          break
      }
    }
  }
  
  return(participant.fits[, names(participant.fits) != 'convergence'])
}

participant.fits.minsse <- function(fits) {
    participants <- unique(fits$ID)
  
    participantparams <- data.frame(do.call(rbind, 
                               lapply(participants, 
                                      function(x) minsse(fits[fits$ID == x,]))))
  
    participantparams[, 2:length(participantparams[1,])] <- apply(participantparams[, 2:length(participantparams[1,])], 2, as.numeric)
  
    return(participantparams)
}

convertParms <- function(lhsObject, transformParms = T){
  resSampled <- as.data.frame(matrix(unlist(lapply(1:length(lhsObject[1,]), function(x) 
    lhsObject[,x]*diff(parmRange[,x]) + parmRange[1,x])), 
    nrow = length(lhsObject[,1]), ncol = length(lhsObject[1,])))
  colnames(resSampled) <- c("p1", "p2", "p3", "p4")
  res <- resSampled
  return(res)
}

parmIter <- 1e3
# create latin hypercube to sample possible parameter space
  # and evaluate sse at each of parmIter parameter sets
  # (not optimization, just calculate sse)
sampleLHS <- maximinLHS(parmIter,4)
parmRange <- data.frame(p1 = c(log(1e9), log(1e13)),
                       p2 = c(log(0.1), log(1)),
                       p3 = c(-10, 10),
                       p4 = c(log(10^(-2)), log(0.1)))
row.names(parmRange) <- c("min", "max")

startParms <- convertParms(sampleLHS)

numFits <- 100

noro.evals <- all.evals(noro.FShedData, noro.endpoints, startParms,
                                    detect.threshold = log10(noro.detection.threshold),
                                    detect.threshold.2 = log10(noro.detection.threshold.2))

noro.fits <- all.fits(noro.FShedData, noro.endpoints, noro.evals, numFits,
                                    detect.threshold = log10(noro.detection.threshold),
                                    detect.threshold.2 = log10(noro.detection.threshold.2))

noro.best.fit <- participant.fits.minsse(noro.fits)

sars.evals <- all.evals(sars.TShedData, sars.endpoints, startParms,
                                    detect.threshold = log10(noro.detection.threshold),
                                    detect.threshold.2 = log10(noro.detection.threshold.2))

sars.fits <- all.fits(sars.TShedData, sars.endpoints, sars.evals, numFits,
                                    detect.threshold = log10(sars.detection.threshold))

sars.best.fit <- participant.fits.minsse(sars.fits)
```

### Calculating our measures of interest

Now, we calculate the delay between symptom onset and peak pathogen load for
each participant in each study, which serves as a conservative measure of 
pre-symptomatic transmission. We also look at a 
non-conservative measure of pre-symptomatic transmission, i.e. the 
delay between shedding onset and symptom onset. A negative delay indicates 
pre-symptomatic transmission, while a positive one indicates post-symptomatic
transmission. The delay is in days. 

We also calculate average viral concentration prior to symptoms, average viral 
concentration over the course of infection, and the duration of infection overall
(inoculation to last positive sample) for each person. We then multiply 
average concentration prior to symptoms and overall by incubation period and
duration of infection, respectively, to derive transmission potential before 
symptoms and overall.

```{r}
shed.onset <- function(vldata) {
  if("y_type" %in% colnames(vldata)) {
    return(min(vldata[grepl('POS', vldata$y_type),]$days))
  } else {
    return(min(vldata[!is.na(vldata$y_virus),]$days))
  }
}

shed.end <- function(vldata) {

  if("y_type" %in% colnames(vldata)) {
    return(max(vldata[grepl('POS', vldata$y_type),]$days))
  } else {
    return(max(vldata[!is.na(vldata$y_virus),]$days))
  }
}

avg.shedding <- function(vldata, measure='concentration') {
  
  if(measure == 'total shedding') {
    return(mean(vldata$total_shedding_log10))
  }
  
  vldata$y_virus_logged <- log10(vldata$y_virus)
  
  if('y_type' %in% colnames(vldata)) {
  
    if(length(vldata[grepl('~', vldata$y_type),]$y_virus_logged) > 0) {
      vldata[grepl('~', vldata$y_type),]$y_virus_logged <- mean(log10(c(noro.detection.threshold,
                                                                      noro.detection.threshold.2)))
    }
    
    if(length(vldata[grepl('NEG', vldata$y_type) ,]$y_virus_logged) > 0) {
      vldata[grepl('NEG', vldata$y_type),]$y_virus_logged <- 0
    }
  } else {
    
    if(length(vldata[is.na(vldata$y_virus_logged),]$y_virus_logged) > 0) {
      vldata[is.na(vldata$y_virus_logged),]$y_virus_logged <- 0
    }
  }

  return(mean(vldata$y_virus_logged))
  
}

calc.measures <- function(params, endpoints, vldata, incubdata) {
  
  params <- merge(params, incubdata, by="ID")
  
  if (is.null(incubdata$dose[1])) {
    params$dose <- 10
  }
  
  params$sheddingOnset <- sapply(params$ID, function(id) {
    shed.onset(vldata[vldata$ID == id, ])
  })

  params$growthRate <- log10(params$transp2)
  params$peakDay <- params$transp3/24
  params$symptomsToPeakDay <- params$peakDay - params$incubation
  params$symptomsToStartShedding <- params$sheddingOnset - params$incubation
  
  params$avgSheddingBeforeSymptoms <- apply(params, 1, function(p) {
    avg.shedding(vldata[vldata$ID == p["ID"] & vldata$days < as.numeric(p["incubation"])
                        & vldata$days > 0,])})
  
  params$transmissionBeforeSymptoms <- 
  ifelse(params$avgSheddingBeforeSymptoms == 0, 0,
         log10(10^params$avgSheddingBeforeSymptoms * params$incubation))
 
  params$sheddingEnd <- sapply(params$ID, function(id) {
    shed.end(vldata[vldata$ID == id, ])})
  
  params$avgSheddingOverall <- apply(params, 1, function(p) {
    avg.shedding(vldata[vldata$ID == p["ID"] & vldata$days <= as.numeric(p["sheddingEnd"])
                        & vldata$days > 0,])})
  
  params$transmissionOverall <- log10(10^params$avgSheddingOverall * 
                                                 params$sheddingEnd)
  
  return(params)
}

noro.params <- calc.measures(noro.best.fit, noro.endpoints, noro.FShedData, 
                             noro.IncubData)
sars.params <- calc.measures(sars.best.fit, sars.endpoints, sars.TShedData, 
                             sars.IncubData)
```

We remove measures derived from the fitted model trajectory for participants with 
unclear peaks in their trajectories or < 5 observed data points. 
```{r}
positivePts <- function(data){
  quantifiedAbundance <- is.finite(data$y_virus)
  positiveDetection <- quantifiedAbundance
  if("y_type" %in% colnames(data)){positiveDetection <- grepl("POS", data$y_type)}
  return(length(which(positiveDetection)))
}

# check how many points were fitted
noro.PtsFitted <- do.call(rbind, 
                         lapply(noroParticipants, 
                                function(x) data.frame(x, 
                                                       positivePts((noro.FShedData[noro.FShedData$ID == x,])
                                                                   [1:noro.endpoints$endPt[noro.endpoints$ID==x],]))))
colnames(noro.PtsFitted) <- c('ID', 'points.fit')

# check how many points were fitted
sars.PtsFitted <- do.call(rbind, 
                         lapply(sarsParticipants, 
                                function(x) data.frame(x, 
                                                       positivePts((sars.TShedData[sars.TShedData$ID == x,])
                                                                   [1:sars.endpoints$endPt[sars.endpoints$ID==x],]))))
colnames(sars.PtsFitted) <- c('ID', 'points.fit')

noro.unclearpeaks <- c('ID9', 'ID18', noro.PtsFitted[noro.PtsFitted$points.fit < 5,]$ID)

sars.unclearpeaks <- c('Throat_2', 'Throat_15', 
                       sars.PtsFitted[sars.PtsFitted$points.fit < 5,]$ID)

noro.params[which(noro.params$ID%in%noro.unclearpeaks),][, c('transp1',
                                                              'transp2',
                                                              'transp3',
                                                              'transp4',
                                                              'growthRate',
                                                              'peakDay',
                                                              'symptomsToPeakDay')] <- NA

sars.params[which(sars.params$ID%in%sars.unclearpeaks),][, c('transp1',
                                                              'transp2',
                                                              'transp3',
                                                              'transp4',
                                                              'growthRate',
                                                              'peakDay',
                                                              'symptomsToPeakDay')] <- NA
```

We calculate each study's average shedding and symptom onset, where shedding
onset is defined as time of the first positive viral shedding value.
```{r}
noro.avg.shed.onset <- mean(noro.params$sheddingOnset)
noro.avg.shed.onset

noro.avg.symp.onset <- mean(noro.IncubData$incubation)
noro.avg.symp.onset

sars.avg.shed.onset <- mean(sars.params$sheddingOnset)
sars.avg.shed.onset

sars.avg.symp.onset <- mean(sars.IncubData$incubation, na.rm=T)
sars.avg.symp.onset
```

We then use bootstrapping to create 95% confidence intervals 
(n = 1000) around the linear regressions we show in Figures 4 and S5 as well as 
the mean values per dose we show in Figures 4, S5, and S3.
```{r} 
# Produce projected values as per a linear regression with predictor 
# variable = viral population growth rate
lmMetrics <- function(dataSet, columnName, xValues = NA){
  lmFit <- lm(formula = reformulate("growthRate", response = columnName), data = dataSet)
  res <- predict.lm(lmFit, newdata = data.frame(growthRate = xValues))
  return(res)
} 

growth.summary.table <- function(params, iters, n_points) {
  
  g.range <- seq(min(params$growthRate, na.rm=T),
                    max(params$growthRate, na.rm=T),
                    length=n_points)

  summary <- data.frame(growthRate = g.range,
                         peakDay = lmMetrics(params, 'peakDay', g.range),
                         symp = lmMetrics(params, 'incubation', g.range), 
                         sympToPeakDay = lmMetrics(params, 'symptomsToPeakDay', g.range),
                         shedding = lmMetrics(params, 'sheddingOnset', g.range),
                         sympToShed = lmMetrics(params, 'symptomsToStartShedding', g.range)
                        )
  
  peakDayResamples <- matrix(NA, nrow = iters, ncol = n_points)
  sympResamples <- matrix(NA, nrow = iters, ncol = n_points)
  sympToPeakDayResamples <- matrix(NA, nrow = iters, ncol = n_points)
  sheddingResamples <- matrix(NA, nrow = iters, ncol = n_points)
  sympToShedResamples <- matrix(NA, nrow = iters, ncol = n_points)
  
  for(i in 1:iters){
    params.resampled <- params[
      sample(1:nrow(params), 
             size=nrow(params),
             replace=T),]
  
    peakDayResamples[i, ] <- lmMetrics(params.resampled, 'peakDay', g.range)
    sympResamples[i, ] <- lmMetrics(params.resampled, 'incubation', g.range)
    sympToPeakDayResamples[i, ] <- lmMetrics(params.resampled, 'symptomsToPeakDay', g.range)
    sheddingResamples[i, ] <- lmMetrics(params.resampled, 'sheddingOnset', g.range)
    sympToShedResamples[i, ] <- lmMetrics(params.resampled, 'symptomsToStartShedding', g.range)
      
  }
  
  summary$peakDayLCI <- 
    apply(peakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025))
  summary$peakDayUCI <- 
    apply(peakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975))
  
  summary$sympLCI <- 
    apply(sympResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025))
  summary$sympUCI <- 
    apply(sympResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975))
  
  summary$sympToPeakDayLCI <- 
    apply(sympToPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025))
  summary$sympToPeakDayUCI <- 
    apply(sympToPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975))
  
  summary$sheddingLCI <- 
    apply(sheddingResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025))
  summary$sheddingUCI <- 
    apply(sheddingResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975))
  
  summary$sympToShedLCI <- 
    apply(sympToShedResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025))
  summary$sympToShedUCI <- 
    apply(sympToShedResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975))
  
  return(summary)
}

dose.summary.table <- function(params, iters, pathogen) {
  
  doses <- rev(unique(params$dose))
  n_points <- length(doses)

  if(pathogen == 'Norovirus') {
    summary <- as.data.frame(params %>% group_by(dose) %>% summarise(across(c(symptomsToPeakDay,
                                                                                  symptomsToStartShedding,
                                                                                  incubation,
                                                                                  peakDay,
                                                                                  growthRate), 
                                            ~ mean(.x, na.rm=TRUE))))
    
    avgPeakDayResamples <- matrix(NA, nrow = iters, ncol = n_points)
    avggrowthRateResamples <- matrix(NA, nrow = iters, ncol = n_points)
    avgIncubResamples <- matrix(NA, nrow = iters, ncol = n_points)
  } else {
    summary <- as.data.frame(params %>% group_by(dose) %>% summarise(across(c(symptomsToPeakDay, 
                                                                            symptomsToStartShedding),
                                            ~ mean(.x, na.rm=TRUE))))
  }
  
  avgSympToPeakDayResamples <- matrix(NA, nrow = iters, ncol = n_points)
  avgSympToShedResamples <- matrix(NA, nrow = iters, ncol = n_points)
  
  if(pathogen == 'Norovirus') {
    
    for (i in 1:iters) {
      params.resampled <- params[
      sample(1:nrow(params), 
             size=nrow(params),
             replace=T),]
      
      avgSympToPeakDayResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$symptomsToPeakDay)
      }))
      
      avgSympToShedResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$symptomsToStartShedding)
      }))
      
      avgPeakDayResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$peakDay)
      }))
      
      avggrowthRateResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$growthRate)
      }))
      
      avgIncubResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$incubation)
      }))
      
    }
    
    summary$avgPeakDayLCI <- 
      apply(avgPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025, na.rm=T))
    summary$avgPeakDayUCI <- 
      apply(avgPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975, na.rm=T))
    
    summary$avggrowthRateLCI <- 
      apply(avggrowthRateResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025, na.rm=T))
    summary$avggrowthRateUCI <- 
      apply(avggrowthRateResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975, na.rm=T))
    
    summary$avgIncubLCI <- 
      apply(avgIncubResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025, na.rm=T))
    summary$avgIncubUCI <- 
      apply(avgIncubResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975, na.rm=T))
    
  } else {
    for (i in 1:iters) {
      params.resampled <- params[
      sample(1:nrow(params), 
             size=nrow(params),
             replace=T),]
      
      avgSympToPeakDayResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$symptomsToPeakDay,
             na.rm=T)
      }))
      
      avgSympToShedResamples[i, ] <- unlist(lapply(doses, function(d) {
        mean(params.resampled[params.resampled$dose == d,]$symptomsToStartShedding,
             na.rm=T)
      }))
      
    }
  }
  
  summary$avgSympToPeakDayLCI <- 
    apply(avgSympToPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025,
                                                                            na.rm=T))
  summary$avgSympToPeakDayUCI <- 
    apply(avgSympToPeakDayResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975,
                                                                            na.rm=T))
  summary$avgSympToShedLCI <- 
    apply(avgSympToShedResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.025, 
                                                                         na.rm=T))
  
  summary$avgSympToShedUCI <- 
    apply(avgSympToShedResamples, MARGIN = 2, FUN = function(c) quantile(c, 0.975, 
                                                                         na.rm=T))
    
  return(summary)
}

noroSummary.growth <- growth.summary.table(noro.params,
                                 1000, 10)

sarsSummary.growth <- growth.summary.table(sars.params,
                                 1000, 10)

noroSummary.dose <- dose.summary.table(noro.params,
                                       1000,
                                       'Norovirus')

sarsSummary.dose <- dose.summary.table(sars.params,
                                       1000,
                                       'SARS-CoV-2')
```

We also looked at total shedding prior to symptoms for norovirus. This is
calculated as log10(volume of each fecal sample * concentration of virus in each sample).
This was done using stool sample weight and viral concentration data provided by 
request by the authors of the Ge *et al.*, 2023 study.
```{r}
check.concentration.match <- function(ge.vldata, atmar.vldata) {
  # Get rid of pre-inoculation row
  ge.vldata <- ge.vldata[2:nrow(ge.vldata),]
  
  # Putting in placeholder for NA for comparison between sets
  atmar.vldata[atmar.vldata$quantity == '<40000000' | 
                atmar.vldata$quantity == '<225000',]$quantity <- '-1'
  ge.vldata[is.na(ge.vldata$y_virus),]$y_virus <- -1
  
  ge.vldata[grepl('POS', ge.vldata$y_type),]$y_type <- 'POS'
  ge.vldata[grepl('NEG', ge.vldata$y_type),]$y_type <- 'NEG'

  quantresults.same <- setequal(signif(ge.vldata$y_virus, 3),
                                signif(as.numeric(atmar.vldata$quantity), 3))
  qualresults.same <- setequal(ge.vldata$y_type, atmar.vldata$qual.pcr.result)

  return(qualresults.same & quantresults.same)
}

noro.concentrationRaw <- read.csv(here("data", "Ge stool concentrations.csv"))
noro.concentrationRaw <- noro.concentrationRaw[noro.concentrationRaw$studyday > 0,]

noro.concentrationRaw_split <- noro.concentrationRaw %>% 
  group_split(volnum)
names(noro.concentrationRaw_split) <- noro.concentrationRaw %>% 
  distinct(volnum) %>%
  pull()

noro.FShedData.unaggregated_split <- noro.FShedData.unaggregated %>% 
  group_split(ID)
ids <- sapply(noro.FShedData.unaggregated_split, function(df) unique(df$ID))
noro.FShedData.unaggregated_split <- noro.FShedData.unaggregated_split[order(as.numeric(substr(ids, 3, nchar(ids))))]
names(noro.FShedData.unaggregated_split) <- noro.FShedData.unaggregated %>%
  distinct(ID) %>%
  pull()

matches <- crossing(atmarID = names(noro.concentrationRaw_split),
                    geID = names(noro.FShedData.unaggregated_split)) %>%
  mutate(
    match = map2_lgl(
      geID,
      atmarID,
      ~ check.concentration.match(noro.FShedData.unaggregated_split[[.x]], 
                                  noro.concentrationRaw_split[[.y]])
    )
  ) %>% filter(match) %>% select(-match)

# Manually adding in ID20/755 because there is one shedding data point missing
# from the Ge shedding  data for ID20. Otherwise everything aligns

matches <- matches %>% add_row(atmarID = '755', geID = 'ID20')

noro.concentrationRaw <- noro.concentrationRaw[
  noro.concentrationRaw$qual.pcr.result == 'POS',]

noro.concentrationRaw <- merge(noro.concentrationRaw, matches,
                               by.x = 'volnum', by.y = 'atmarID')

# Replace dates with time since inoculation (by matching up viral concentration
# of the samples, and then for qualitative results, by manually filling in days 
# as order does not matter here). We also manually filled in days where viral
# concentrations did not match up due to rounding. We were unable to match
# up lognum = 101527 to a data point in the noroData.rds file from Ge et al., 2023,
# so we excluded it.
noro.concentrationRaw <-  merge(noro.concentrationRaw, 
                                noro.FShedData.unaggregated[, c("days", "y_virus")],
                               by.x = 'quantity', by.y = 'y_virus', 
                               all.x = TRUE)

noro.concentrationRaw <- read.csv(here("data", "Ge stool sample concentrations mapped days.csv"))

# Combine with sample weight data to calculate shedding data
noro.weights <- read.csv(here("data", "Ge stool sample weights.csv"))

noro.totalshedding <- merge(noro.concentrationRaw, 
                            noro.weights[, c("stoollognum", "weight")],
                            by.x = 'lognum', by.y='stoollognum')

noro.totalshedding$total_shedding_log10 <- ifelse(grepl('<', noro.totalshedding$quantity),
                                                  mean(log10(c(noro.detection.threshold, 
                                                               noro.detection.threshold.2))) + 
                                                    log10(noro.totalshedding$weight),
                                                  log10(as.numeric(noro.totalshedding$quantity) * noro.totalshedding$weight))

# Average total shedding values at the same time point
avg_shedding <- aggregate(total_shedding_log10 ~ geID + days, 
                              noro.totalshedding,
                              mean)

avg_shedding <- avg_shedding[order(as.numeric(substring(avg_shedding$geID, 3, 4)),
                       avg_shedding$days),]$total_shedding_log10

noro.totalshedding <- noro.totalshedding[
  !duplicated(noro.totalshedding[, c('geID', 'days')]),]

noro.totalshedding <- noro.totalshedding[
  order(as.numeric(substring(noro.totalshedding$geID, 3, 4)),
                       noro.totalshedding$days),][c('geID', 'days')]

noro.totalshedding$total_shedding_log10 <- avg_shedding

# Add total shedding as column to noro.FShedData dataframe

noro.FShedData <- merge(noro.FShedData,
                        noro.totalshedding,
                        by.x = c("ID", "days"), by.y=c("geID", "days"),
                        all.x=TRUE)

noro.FShedData[grepl('NEG', noro.FShedData$y_type),]$total_shedding_log10 <- 0

noro.params$avgTotalSheddingBeforeSymptoms <- apply(noro.params, 1,  
                               function(x) avg.shedding(
                                 noro.FShedData[noro.FShedData$ID == x[1] & 
                                                      noro.FShedData$days > 0 &
                                                      noro.FShedData$days < 
                                                      as.numeric(x['incubation']),],
                                 'total shedding'))
```

### Linear regressions

Norovirus linear regressions
```{r}
# Peak viral load vs. delay (conservative)
lm.fit.p1.delay.conservative.noro <- 
  lm(symptomsToPeakDay ~ p1, data=noro.params)
p1.delay.conservative.pval.noro <- 
  summary(lm.fit.p1.delay.conservative.noro)$coefficients[2,4]
p1.delay.conservative.pval.noro

# Viral population growth rate vs. delay (conservative)
lm.fit.p2.delay.conservative.noro <- 
  lm(symptomsToPeakDay ~ p2, data=noro.params)
p2.delay.conservative.pval.noro <- 
  summary(lm.fit.p2.delay.conservative.noro)$coefficients[2,4]
p2.delay.conservative.pval.noro
p2.delay.conservative.rsquared.noro <- summary(lm.fit.p2.delay.conservative.noro)$r.squared
p2.delay.conservative.rsquared.noro

# Time of peak viral load vs. delay (conservative)
lm.fit.p3.delay.conservative.noro <- 
  lm(symptomsToPeakDay ~ p3, data=noro.params)
p3.delay.conservative.pval.noro <- 
  summary(lm.fit.p3.delay.conservative.noro)$coefficients[2,4]
p3.delay.conservative.pval.noro

# Viral decay rate vs. delay (conservative)
lm.fit.p4.delay.conservative.noro <- 
  lm(symptomsToPeakDay ~ p4, data=noro.params)
p4.delay.conservative.pval.noro <- 
  summary(lm.fit.p4.delay.conservative.noro)$coefficients[2,4]
p4.delay.conservative.pval.noro

# Delay (conservative) vs. dose 
lm.fit.dose.delay.conservative.noro <- 
  lm(symptomsToPeakDay ~ dose, data=noro.params)
dose.delay.conservative.pval.noro <- 
  summary(lm.fit.dose.delay.conservative.noro)$coefficients[2,4]
dose.delay.conservative.pval.noro

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.noro <- 
  lm(p4 ~ p2, data=noro.params[!noro.params$ID %in% noro.unclearpeaks])
p4.p2.conservative.pval.noro <- 
  summary(lm.fit.p4.p2.conservative.noro)$coefficients[2,4]
p4.p2.conservative.pval.noro

# Peak viral load vs. delay (non-conservative)
lm.fit.p1.delay.nonconservative.noro <- 
  lm(symptomsToStartShedding ~ p1, data=noro.params)
p1.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p1.delay.nonconservative.noro)$coefficients[2,4]
p1.delay.nonconservative.pval.noro

# Viral population growth rate vs. delay (non-conservative)
lm.fit.p2.delay.nonconservative.noro <- lm(symptomsToStartShedding ~ p2, 
                                           data=noro.params)
p2.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p2.delay.nonconservative.noro)$coefficients[2,4]
p2.delay.nonconservative.pval.noro

# Time of peak viral load vs. delay (non-conservative)
lm.fit.p3.delay.nonconservative.noro <- 
  lm(symptomsToStartShedding ~ p3, data=noro.params)
p3.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p3.delay.nonconservative.noro)$coefficients[2,4]
p3.delay.nonconservative.pval.noro

# Viral decay rate vs. delay (non-conservative)
lm.fit.p4.delay.nonconservative.noro <- 
  lm(symptomsToStartShedding ~ p4, data=noro.params)
p4.delay.nonconservative.pval.noro <- 
  summary(lm.fit.p4.delay.nonconservative.noro)$coefficients[2,4]
p4.delay.nonconservative.pval.noro

# Delay (non-conservative) vs. dose 
lm.fit.dose.delay.nonconservative.noro <- 
  lm(symptomsToStartShedding ~ dose, data=noro.params)
dose.delay.nonconservative.pval.noro <- 
  summary(lm.fit.dose.delay.nonconservative.noro)$coefficients[2,4]
dose.delay.nonconservative.pval.noro

# Average shedding prior to symptoms vs. incubation period
lm.fit.avg.presymp.shedding.duration.noro <- lm(avgSheddingBeforeSymptoms ~ incubation, 
                              data = noro.params)
avg.presymp.shedding.duration.pval.noro <- 
  summary(lm.fit.avg.presymp.shedding.duration.noro)$coefficients[2,4]
avg.presymp.shedding.duration.pval.noro

# Average total shedding prior to symptoms vs. incubation period
avg.presymp.totalshedding.duration.fit.noro <- lm(avgTotalSheddingBeforeSymptoms ~ 
                                                        incubation, data=noro.params)
avg.presymp.totalshedding.duration.pval.noro <- summary(avg.presymp.totalshedding.duration.fit.noro)$
  coefficients[2, 4]
avg.presymp.totalshedding.duration.pval.noro

# Average shedding overall vs. length of infection
transmission.avg.fit.noro <- lm(avgSheddingOverall ~ sheddingEnd, 
                              data = noro.params)
transmission.avg.pval.noro <- 
  summary(transmission.avg.fit.noro)$coefficients[2,4]
transmission.avg.pval.noro
transmission.avg.rsquared.noro <- summary(transmission.avg.fit.noro)$r.squared
transmission.avg.rsquared.noro

# Transmission prior to symptoms vs. viral population growth rate
lm.fit.p2.presymp.transmission.noro <- lm(transmissionBeforeSymptoms ~ growthRate, 
                              data = noro.params)
p2.presymp.transmission.pval.noro <- 
  summary(lm.fit.p2.presymp.transmission.noro)$coefficients[2,4]
p2.presymp.transmission.pval.noro

# Transmission throughout infection vs. viral population growth rate
lm.fit.p2.overall.transmission.noro <- lm(transmissionOverall ~ growthRate, 
                              data = noro.params)
p2.overall.transmission.pval.noro <- 
  summary(lm.fit.p2.overall.transmission.noro)$coefficients[2,4]
p2.overall.transmission.pval.noro

p2.overall.transmission.rsquared.noro <- 
  summary(lm.fit.p2.overall.transmission.noro)$r.squared
p2.overall.transmission.rsquared.noro

# Time of peak viral load vs. viral population growth rate
lm.fit.p2.peaktime.noro <- lm(peakDay ~ p2, 
                              data=noro.params)
p2.peaktime.pval.noro <- summary(lm.fit.p2.peaktime.noro)$coefficients[2,4]
p2.peaktime.pval.noro
p2.peaktime.rsquared.noro <- summary(lm.fit.p2.peaktime.noro)$r.squared
p2.peaktime.rsquared.noro

# Shedding onset vs. viral population growth rate
lm.fit.p2.shedonset.noro <- lm(sheddingOnset ~ p2, 
                                           data=noro.params)
p2.shedonset.pval.noro <- 
  summary(lm.fit.p2.shedonset.noro)$coefficients[2,4]
p2.shedonset.pval.noro

p2.shedonset.rsquared.noro <- 
  summary(lm.fit.p2.shedonset.noro)$r.squared
p2.shedonset.rsquared.noro

# Incubation period vs. viral population growth rate
lm.fit.p2.symponset.noro <- lm(incubation ~ p2, data=noro.params[!noro.params$ID %in% noro.unclearpeaks,])
p2.symponset.pval.noro <- summary(lm.fit.p2.symponset.noro)$coefficients[2,4]
p2.symponset.pval.noro

p2.symponset.rsquared.noro <- 
  summary(lm.fit.p2.symponset.noro)$r.squared
p2.symponset.rsquared.noro

# Incubation period vs. inoculum dose
lm.fit.dose.symponset.noro <- lm(incubation ~ dose,
                                 data=noro.params)
dose.symponset.pval.noro <- summary(lm.fit.dose.symponset.noro)$coefficients[2,4]
dose.symponset.pval.noro
```

SARS-CoV-2 linear regressions
```{r}
# Peak viral load vs. delay (conservative)
lm.fit.p1.delay.conservative.sars <- 
  lm(symptomsToPeakDay ~ p1, data=sars.params)
p1.delay.conservative.pval.sars <- 
  summary(lm.fit.p1.delay.conservative.sars)$coefficients[2,4]
p1.delay.conservative.pval.sars

# Viral population growth rate vs. delay (conservative)
lm.fit.p2.delay.conservative.sars <- 
  lm(symptomsToPeakDay ~ p2, data=sars.params)
p2.delay.conservative.pval.sars <- 
  summary(lm.fit.p2.delay.conservative.sars)$coefficients[2,4]
p2.delay.conservative.pval.sars
p2.delay.conservative.rsquared.sars <- summary(lm.fit.p2.delay.conservative.sars)$r.squared
p2.delay.conservative.rsquared.sars

# Time of peak viral load vs. delay (conservative)
lm.fit.p3.delay.conservative.sars <- 
  lm(symptomsToPeakDay ~ p3, data=sars.params)
p3.delay.conservative.pval.sars <- 
  summary(lm.fit.p3.delay.conservative.sars)$coefficients[2,4]
p3.delay.conservative.pval.sars

# Viral decay rate vs. delay (conservative)
lm.fit.p4.delay.conservative.sars <- 
  lm(symptomsToPeakDay ~ p4, data=sars.params)
p4.delay.conservative.pval.sars <- 
  summary(lm.fit.p4.delay.conservative.sars)$coefficients[2,4]
p4.delay.conservative.pval.sars

# Viral growth vs. decay rate
lm.fit.p4.p2.conservative.sars <- 
  lm(p4 ~ p2, data=sars.params[!sars.params$ID %in% sars.unclearpeaks])
p4.p2.conservative.pval.sars <- 
  summary(lm.fit.p4.p2.conservative.sars)$coefficients[2,4]
p4.p2.conservative.pval.sars

# Peak viral load vs. delay (non-conservative)
lm.fit.p1.delay.nonconservative.sars <- 
  lm(symptomsToStartShedding ~ p1, data=sars.params)
p1.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p1.delay.nonconservative.sars)$coefficients[2,4]
p1.delay.nonconservative.pval.sars

# Viral population growth rate vs. delay (non-conservative)
lm.fit.p2.delay.nonconservative.sars <- 
  lm(symptomsToStartShedding ~ p2, data=sars.params)
p2.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p2.delay.nonconservative.sars)$coefficients[2,4]
p2.delay.nonconservative.pval.sars

# Time of peak viral load vs. delay (non-conservative)
lm.fit.p3.delay.nonconservative.sars <- 
  lm(symptomsToStartShedding ~ p3, data=sars.params)
p3.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p3.delay.nonconservative.sars)$coefficients[2,4]
p3.delay.nonconservative.pval.sars

# Viral decay rate vs. delay (non-conservative)
lm.fit.p4.delay.nonconservative.sars <- 
  lm(symptomsToStartShedding ~ p4, data=sars.params)
p4.delay.nonconservative.pval.sars <- 
  summary(lm.fit.p4.delay.nonconservative.sars)$coefficients[2,4]
p4.delay.nonconservative.pval.sars

# Average shedding prior to symptoms vs. incubation period
lm.fit.avg.presymp.shedding.duration.sars <- lm(avgSheddingBeforeSymptoms ~ incubation, 
                              data = sars.params)
avg.presymp.shedding.duration.pval.sars <- 
  summary(lm.fit.avg.presymp.shedding.duration.sars)$coefficients[2,4]
avg.presymp.shedding.duration.pval.sars

# Average shedding overall vs. length of infection
transmission.avg.fit.sars <- lm(avgSheddingOverall ~ sheddingEnd, 
                              data = sars.params)
transmission.avg.pval.sars <- 
  summary(transmission.avg.fit.sars)$coefficients[2,4]
transmission.avg.pval.sars

# Transmission prior to symptoms vs. viral population growth rate
lm.fit.p2.presymp.transmission.sars <- lm(transmissionBeforeSymptoms ~ growthRate, 
                              data = sars.params)
p2.presymp.transmission.pval.sars <- 
  summary(lm.fit.p2.presymp.transmission.sars)$coefficients[2,4]
p2.presymp.transmission.pval.sars

# Transmission throughout infection vs. viral population growth rate
lm.fit.p2.overall.transmission.sars <- lm(transmissionOverall ~ growthRate, 
                              data = sars.params)
p2.overall.transmission.pval.sars <- 
  summary(lm.fit.p2.overall.transmission.sars)$coefficients[2,4]
p2.overall.transmission.pval.sars

# Time of peak viral load vs. viral population growth rate
lm.fit.p2.peaktime.sars <- lm(peakDay ~ p2, data=sars.params)
p2.peaktime.pval.sars <- summary(lm.fit.p2.peaktime.sars)$coefficients[2,4]
p2.peaktime.pval.sars

p2.peaktime.rsquared.sars <- summary(lm.fit.p2.peaktime.sars)$r.squared
p2.peaktime.rsquared.sars

# Shedding onset vs. viral population growth rate
lm.fit.p2.shedonset.sars <- lm(sheddingOnset ~ p2, 
                                           data=sars.params)
p2.shedonset.pval.sars <- 
  summary(lm.fit.p2.shedonset.sars)$coefficients[2,4]
p2.shedonset.pval.sars

p2.shedonset.rsquared.sars <- 
  summary(lm.fit.p2.shedonset.sars)$r.squared
p2.shedonset.rsquared.sars

# Incubation period vs. viral population growth rate
lm.fit.p2.symponset.sars <- lm(incubation ~ p2, data=sars.params[!sars.params$ID %in% sars.unclearpeaks,])
p2.symponset.pval.sars <- summary(lm.fit.p2.symponset.sars)$coefficients[2,4]
p2.symponset.pval.sars

p2.symponset.rsquared.sars <- 
  summary(lm.fit.p2.symponset.sars)$r.squared
p2.symponset.rsquared.sars
```

### Plotting code

We plot trajectories for every individual.
```{r, fig.height = 7.5, fig.width = 3.5}
plot.viralload <- function(vldata, pars, sympdata, t.range, cex=1,
                           yaxisLabs = T, col, pch, xmax=25, ylim.lower=3,
                           cex_labels, cex.axis, xlabel, xlabel.line=3.5, x.tick.line=0.75,
                           ylabel, ylabel.line=4.5, y.tick.line=1, panellabel, 
                           example=FALSE, metric='concentration') {

  # Plotting real shedding values
  plot(1, col=col, xlim=c(0, xmax), 
       ylim=c(ylim.lower, 15), xlab="", ylab="", xaxt="n", yaxt="n", cex.lab=cex, 
       cex.axis=cex, font.lab=2, bty='n', yaxs="i", xaxs="i")
  
  if(metric=='concentration') {yvals <- log10(vldata$y_virus)} 
  else {yvals <- vldata$total_shedding_log10}
  
  points(vldata$days, yvals, col=col, cex=cex, pch=pch)
  
  # Rectangles where viral shedding is a range (qualitative results)
  range.indexes <- which(grepl('~', vldata$y_type))
  rectangle.x_vals <- lapply(range.indexes, function(x) c(vldata[x,]$days - 0.25, 
                                                          vldata[x,]$days + 0.25))
  lapply(rectangle.x_vals, function(x) 
    rect(x[1], log10(noro.detection.threshold), x[2], log10(noro.detection.threshold.2), border=NA, 
         col='#d9adcf'))
  
  # Black lines where viral shedding is undetectable
  if ('y_type' %in% colnames(vldata)) {
    undetectable.indexes <- which(grepl('NEG', vldata$y_type))
  } else {
    undetectable.indexes <- which(is.na(yvals) & vldata$days > 0)
  }
  lines.x_vals <- lapply(undetectable.indexes, function(x) c(vldata[x,]$days - 0.25, 
                                                          vldata[x,]$days + 0.25))
  
  lapply(lines.x_vals, lines, y=rep(ylim.lower, 2), lwd=4)
  
  # Symptom onset
  symp.onset <- sympdata$incubation
  
  if ('y_type' %in% colnames(vldata) || 
      ('end' %in% colnames(sympdata) && any(is.na(sympdata$end)))) {
    symp.end <- xmax
  } else {
    symp.end <- sympdata$end
  }
  
  polygon(x=c(symp.onset,
              symp.onset,
              symp.end, 
              symp.end), 
          y=c(ylim.lower, 15, 15, ylim.lower), 
          col=rgb(200, 200, 200, alpha=100,
                  maxColorValue=255),
          border = NA)
  
  # Trajectories from statistical model
  if(metric == 'concentration') {
  
    predValues <- sse.viralLoad(pars, vldata[1:t.range$endPt,], optimization = F)
    linet <- predValues$t
    predictedvl <- predValues$predData
    
    predictedvl[!is.finite(predictedvl)] <- 0
  
    lines(linet / 24, predictedvl, col=col)
    
    # Peak shedding
    t.peak <- sse.viralLoad(pars, vldata[1:t.range$endPt,], optimization = NA)[3]/24
    peakHeight <- sse.viralLoad(pars, vldata[1:t.range$endPt,], optimization = NA)[1]
    
    if (is.na(symp.onset)) {
      redpointstyle <- NA
    } else if (t.peak < symp.onset) {
      redpointstyle <- 19
    } else if (t.peak > symp.onset) {
      redpointstyle <- 1
    } else {
      redpointstyle <- 9
    }
    
    points(t.peak, peakHeight, pch=redpointstyle,
           col="red", lwd=cex, cex=cex)
    
  }

  if(!example){
    xLabs <- c(expression(0),
              expression(5),
              expression(10),
              expression(15),
              expression(20),
              expression(25))
  axis(1, cex.axis=cex.axis, at=seq(0, xmax, by=5), labels = xLabs,
       line=0, mgp=c(2, x.tick.line, 0), tck=-0.04)
  } else {
  axis(1, cex.axis=cex.axis, line=0, mgp=c(2, x.tick.line, 0), tck=-0.04)
  }
  
  
  yLabs = NA
  if(yaxisLabs==T){
      yLabs = c(expression(10^3),
                expression(10^6),
                expression(10^9),
                expression(10^12),
                expression(10^15))}
  axis(2, cex.axis=cex.axis, at=seq(3, 15, by=3), 
       labels=yLabs,
       line=0,
       las=2, 
       mgp=c(2, y.tick.line, 0), tck= -0.04)
  
  mtext(text=xlabel, side=1, line=xlabel.line, cex=cex_labels)
  mtext(text=ylabel, side=2, line=ylabel.line, cex=cex_labels)
  
  if (example) {
    text(x=.93 * xmax, y=.93 * (15- ylim.lower) + ylim.lower, labels=panellabel, 
         cex=cex, font=2)
  } else {
    text(x=.8 * xmax, y=.8 * (15 - ylim.lower) + ylim.lower, labels=panellabel, 
         font=2)
  }
  
}
```

We plot the trajectories of each participant from both studies. For norovirus,
we compare fits with those from Ge *et al.*, 2023.
```{r, fig.height = 7.5, fig.width = 6.5}
noroDataBayesian <- readRDS(here("data", "holder_curves_mu_id_con20.rds")) 
noro.FShedDataBayesian <- bind_rows(noroDataBayesian)

sars.color <- "#56b3e9"
noro.color <- "#871a6e"
sars.pch <- 5
noro.pch <- 2

tiff('Figure 2.tiff', res=500, width=6.5, height=7, unit='in')
{
  par(mfrow=c(7, 3), mai=c(0.1, 0.42, 0.22, 0.22), oma=c(3.5, 5, 0, 0),
      mar=c(1, 2.1, 1, 1))
  
  for(i in 1:length(noroParticipants)) {
    
    p <- noroParticipants[i]
    participantdata <- noro.FShedData[noro.FShedData$ID==p, ]
    sympdata <- noro.IncubData[noro.IncubData$ID==p, ]
    params <- unlist(noro.params[noro.params$ID==p,][2:5])
    participantdata.bayesian <- noro.FShedDataBayesian[noro.FShedDataBayesian$ID == p,]
    t.range <- noro.endpoints[noro.endpoints$ID==p,]
    col <- noro.color
    pch <- noro.pch
    
    if(p %in% noro.unclearpeaks) {
      plab <- paste(unique(participantdata$ID), ',\n excluded', sep='')
    } else{
      plab <- unique(participantdata$ID)
    }
    
    if (i==19) {
      plot.viralload(
        vldata=participantdata,
        pars=params,
        sympdata=sympdata,
        t.range=t.range,
        col=col,
        pch=pch,
        ylim.lower = 7,
        cex_labels=0.8,
        cex.axis=1.25,
        xlabel="Days after inoculation",
        xlabel.line=2,
        ylabel="Viral shedding\n(concentration)",
        ylabel.line=4,
        panellabel=plab)
    } else if (i %in% seq(1, 16, by=3)) {
      plot.viralload(
        vldata=participantdata,
        pars=params,
        sympdata=sympdata,
        t.range=t.range,
        col=col,
        pch=pch,
        ylim.lower = 7,
        cex_labels=0.8,
        cex.axis=1.25,
        xlabel="",
        ylabel="Viral shedding\n(concentration)",
        ylabel.line=4,
        panellabel=plab)
    } else if (i %in% c(18, 20)) {
       plot.viralload(
        vldata=participantdata,
        pars=params,
        sympdata=sympdata,
        t.range=t.range,
        yaxisLabs=F,
        col=col,
        pch=pch,
        ylim.lower = 7,
        cex_labels=0.8,
        cex.axis=1.25,
        xlabel="Days after inoculation",
        xlabel.line=2,
        ylabel="",
        panellabel=plab)
    } else {
      plot.viralload(
      vldata=participantdata,
      pars=params,
      sympdata=sympdata,
      t.range=t.range,
      yaxisLabs=F,
      col=col,
      pch=pch,
      ylim.lower = 7,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="",
      panellabel=plab)
    }
    
    lines(participantdata.bayesian$days, 
          log10(exp(participantdata.bayesian$Estimate)), col="#22a841", lty=3)
    
  }
  
  plot.new()
  plot.window(xlim=c(0, 1), ylim=c(0, 1))
  
  legend(0, 0.75, legend=c("Ge et al., 2023 fits", "Our fits",
                           "No symp/symp"), lty=c(3, 1, NA),
         col=c("#22a841", noro.color, NA), bty='n')
}
dev.off()

tiff('Figure 3.tiff', res=500, 
     width=6.5, height=6.5, unit='in')

par(mfrow=c(6, 3), mai=c(0.22, 0.42, 0.22, 0.22), oma=c(3.5, 5, 0, 0),
    mar=c(1, 2.1, 1, 1))

for(i in 1:length(sarsParticipants)) {
  
  p <- sarsParticipants[i]
  participantdata <- sars.TShedData[sars.TShedData$ID==p, ]
  sympdata <- sars.IncubData[sars.IncubData$ID==p, ]
  params <- unlist(sars.params[sars.params$ID==p,][2:5])
  t.range <- sars.endpoints[sars.endpoints$ID==p,]
  
  if(p %in% sars.unclearpeaks) {
    plab <- paste(unique(participantdata$ID), ',\n excluded', sep='')
  } else{
    plab <- unique(participantdata$ID)
  }
  
  if (i %in% seq(1, 13, by=3)) {
    plot.viralload(
      vldata=participantdata,
      sympdata=sympdata,
      pars=params,
      t.range=t.range,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="",
      ylabel="Viral shedding\n(concentration)",
      ylabel.line=4,
      panellabel=plab)
  } else if (i %in% c(17, 18)) {
     plot.viralload(
      vldata=participantdata,
      sympdata=sympdata,
      pars=params,
      t.range=t.range,
      yaxisLabs=F,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      xlabel.line=2,
      ylabel="",
      panellabel=plab)
  } else if (i==16) {
    plot.viralload(
      vldata=participantdata,
      sympdata=sympdata,
      pars=params,
      t.range=t.range,
      col=sars.color,
      pch=sars.pch,
      cex_labels=0.8,
      cex.axis=1.25,
      xlabel="Days after inoculation",
      xlabel.line=2,
      ylabel="Viral shedding\n(concentration)",
      ylabel.line=4,
      panellabel=plab)
  } else {
    plot.viralload(
    vldata=participantdata,
    sympdata=sympdata,
    pars=params,
    t.range=t.range,
    yaxisLabs=F,
    col=sars.color,
    pch=sars.pch,
    cex_labels=0.8,
    cex.axis=1.25,
    xlabel="",
    ylabel="",
    panellabel=plab)
  }
  
}

legend(10, 10, legend=c("No symp/symp"), bty='n')

dev.off()
```

We plot the delay between symptom onset and peak viral shedding for each virus and dose,
delay vs. viral population growth rate, day of peak shedding vs. viral population growth rate, and
day of symptom onset vs. viral population growth rate in a 4-panel plot.
```{r, fig.height = 7.5, fig.width = 3.5}
measure.names <- c("ID", "dose", "incubation", "sheddingOnset", "growthRate",
                   "peakDay", "symptomsToPeakDay", "symptomsToStartShedding",
                   "avgSheddingBeforeSymptoms", "incubation",
                   "avgSheddingOverall", "sheddingEnd",
                   "transmissionBeforeSymptoms", "transmissionOverall")

measures.combined <- rbind(noro.params[colnames(noro.params) %in% measure.names], 
                           sars.params[colnames(sars.params) %in% measure.names])
measures.combined$pathogen <- ifelse(grepl('ID', measures.combined$ID), 
                                     'Norovirus', 'SARS-CoV-2')

noro.g.range <- seq(min(noro.params$growthRate, na.rm=T),
                    max(noro.params$growthRate, na.rm=T),
                    length=10)

sars.g.range <- seq(min(sars.params$growthRate, na.rm=T),
                    max(sars.params$growthRate, na.rm=T),
                    length=10)

cex <- 1.1
cex.points <- 1
cex_labels <- 0.7
panellabelratio <- 0.975

tiff('Figure 4.tiff', res=500, height=6.5,
     width=3.5, unit='in')
{
  par(mfrow=c(4, 1), oma=c(0.5, 2, 0.5, 0), mai=c(0.3, 0.5, 0.3, 0.1))
  
  # Panel A: Delay between symptom onset and peak viral shedding 
  {
    ylim.ab <- c(floor(min(measures.combined$symptomsToPeakDay, na.rm=T))-1, 
               ceiling(max(measures.combined$symptomsToPeakDay, na.rm=T))+1)
    
    plot(symptomsToPeakDay ~ jitter(ifelse(pathogen == 'Norovirus', 
                                          ifelse(dose == 4.8, .73,
                                                 ifelse(dose == 48, 1.067, 
                                                        ifelse(dose == 4800, 1.4, 0))),
                                     2)), 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xlim=c(.4, 2.6),
       ylim=ylim.ab, cex.axis=cex, cex=cex.points,
       pch=ifelse(symptomsToPeakDay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(symptomsToPeakDay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(symptomsToPeakDay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                5))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       yaxt="n",
       xaxt="n",
       ylab = "",
       xlab = "",
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    axis(1, at=c(0.73, 1.067, 1.4, 2), 
         labels=c('4.8', '48', '4800', '10'), 
         cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    mtext(text='Norovirus dose\n(RT-PCR units)', side=1, line=2.7, cex=cex_labels,
          adj=-0.1)
    mtext(text = expression(paste('SARS-CoV-2 dose\n(', TCID[50], ')', sep="")), side=1, 
          line=2.7, cex=cex_labels, adj=0.85)
    
    axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
    
    #Average delays per pathogen
    segments(0.63, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$symptomsToPeakDay, 
             0.83, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$symptomsToPeakDay, 
             col=noro.color,
             lwd=cex)
    
    segments(0.967, 
             noroSummary.dose[noroSummary.dose$dose == 48,]$symptomsToPeakDay, 
             1.167,
             noroSummary.dose[noroSummary.dose$dose == 48,]$symptomsToPeakDay, 
             col=noro.color,
             lwd=cex)
    
    segments(1.3, 
             noroSummary.dose[noroSummary.dose$dose == 4800,]$symptomsToPeakDay, 
             1.5,
             noroSummary.dose[noroSummary.dose$dose == 4800,]$symptomsToPeakDay, 
             col=noro.color,
             lwd=cex)
    
    segments(1.9, 
             sarsSummary.dose$symptomsToPeakDay, 
             2.1,
             sarsSummary.dose$symptomsToPeakDay, col=sars.color,
             lwd=cex)
    
    # Confidence bounds
     polygon(c(0.63, 0.83, 0.83, 0.63), c(noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToPeakDayLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToPeakDayLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToPeakDayUCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToPeakDayUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(0.967, 1.167, 1.167, 0.967), c(noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToPeakDayLCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToPeakDayLCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToPeakDayUCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToPeakDayUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.3, 1.5, 1.5, 1.3), c(noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToPeakDayLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToPeakDayLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToPeakDayUCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToPeakDayUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.9, 2.1, 2.1, 1.9), c(sarsSummary.dose$avgSympToPeakDayLCI,
                                         sarsSummary.dose$avgSympToPeakDayLCI,
                                         sarsSummary.dose$avgSympToPeakDayUCI,
                                         sarsSummary.dose$avgSympToPeakDayUCI),
            col=rgb(86, 179, 233, alpha=100,
                    maxColorValue=255), border = NA)
    
    #Pre-symptomatic vs post-symptomatic line
    abline(h=0, lty=3, lwd=cex)
    
    legend(.35, 
           -1, 
           legend=c("Peak shedding before symptoms", "Peak shedding after symptoms"), 
       pch=c(19, 1), col=c("black", "black"), cex=0.9, bty="n")
    
    text(panellabelratio * 2.2 + .4, panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
         ylim.ab[1], labels="A", cex=cex, font=2)
  }
  
  # Panel B: Delay between symptom onset and peak viral shedding vs. viral
  # growth rate
  
  {
    xlim.bcd <- c(-1.25, 0)
    
    plot(symptomsToPeakDay ~ growthRate, data=measures.combined, 
     col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
     pch=ifelse(symptomsToPeakDay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(symptomsToPeakDay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(symptomsToPeakDay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                5))),
     bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
     cex=cex.points, cex.axis=cex,
     ylab="", xlab="", xaxt="n", yaxt="n",
     ylim=ylim.ab,
     xlim=xlim.bcd,
     mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
    bcd.xlabels <- c('',
                     bquote(10^.(-1)),
                     '',
                     bquote(10^.(-0.5)),
                     '',
                     1)
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25),
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
       las=2)
    
    # Lines of best fit
    
    lines(sympToPeakDay ~ growthRate, data=noroSummary.growth, col=noro.color)
    lines(sympToPeakDay ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$sympToPeakDayUCI,
                                                  rev(noroSummary.growth$sympToPeakDayLCI)), 
          col = rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$sympToPeakDayUCI,
                                                  rev(sarsSummary.growth$sympToPeakDayLCI)), 
          col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
    
    abline(h=0, lty=3, lwd=cex)
  
    mtext(text="Day of peak viral shedding \n minus day of symptom onset",
          side=2, line=2.1, cex=cex_labels, adj=-0.5)
    
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1])  + xlim.bcd[1], 
       panellabelratio * (ylim.ab[2] - ylim.ab[1]) + ylim.ab[1], labels="B", 
       cex=cex, font=2)
    
  }
  
  # Panel C: Time of peak shedding vs. Viral population growth rate
  
  {
    ylim.c <- c(floor(min(measures.combined$peakDay, na.rm=T)) - 1, 
                ceiling(max(measures.combined$peakDay, na.rm=T)) + 1)
    
    plot(peakDay ~ growthRate, data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
       xlim=xlim.bcd,
       ylim=ylim.c, cex.axis=cex, cex=cex.points,
       pch=ifelse(symptomsToPeakDay < 0 & pathogen == 'Norovirus', 17, 
                ifelse(symptomsToPeakDay > 0 & pathogen == 'Norovirus', 2,
                       ifelse(symptomsToPeakDay < 0 & pathogen == 'SARS-CoV-2', 23, 
                              5))),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xaxt="n", yaxt="n", ylab = "", xlab = "",
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25), 
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, at=seq(ylim.c[1],ylim.c[2], by=2), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
    
    # Lines of best fit
    lines(peakDay ~ growthRate, data=noroSummary.growth, col=noro.color)
  
    lines(peakDay ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$peakDayUCI,
                                                  rev(noroSummary.growth$peakDayLCI)), 
          col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$peakDayUCI,
                                                  rev(sarsSummary.growth$peakDayLCI)), 
            col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
    
    mtext(text="Day of \npeak shedding", side=2, line=2, cex=cex_labels)
    
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.c[2] - ylim.c[1]) + ylim.c[1], labels="C", 
         cex=cex, font=2)
  }
    
  # Panel D: Symptom onset vs. Viral population growth rate
  
  {
    ylim.d <- c(floor(min(measures.combined[!measures.combined$ID %in% 
                                                c(noro.unclearpeaks, sars.unclearpeaks),]
                          $incubation, na.rm=T)) - 1, 
              ceiling(max(measures.combined[!measures.combined$ID %in% 
                                                c(noro.unclearpeaks, sars.unclearpeaks),]
                          $incubation, na.rm=T)) + 1)
  
    plot(incubation ~ growthRate, data=measures.combined,
         col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         xlim=xlim.bcd, ylim=ylim.d, cex.axis=cex, cex=cex.points,
         pch=ifelse(symptomsToPeakDay < 0 & pathogen == 'Norovirus', 17, 
                  ifelse(symptomsToPeakDay > 0 & pathogen == 'Norovirus', 2,
                         ifelse(symptomsToPeakDay < 0 & pathogen == 'SARS-CoV-2', 23, 
                                5))),
         bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         yaxt="n", xaxt="n", ylab = "", xlab = "", bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25), 
       labels=do.call(expression, bcd.xlabels), 
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    
    axis(2, at=seq(ylim.d[1], ylim.d[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04, las=2)
    
    # Lines of best fit
    lines(symp ~ growthRate, data=noroSummary.growth, col=noro.color)
  
    lines(symp ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$sympUCI,
                                                  rev(noroSummary.growth$sympLCI)), 
            col = rgb(135, 26, 110, alpha=100,
                    maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$sympUCI,
                                                  rev(sarsSummary.growth$sympLCI)), 
            col=rgb(86, 179, 233, alpha=100,
                    maxColorValue=255), border = NA)
    
    mtext(text="Day of \nsymptom onset", side=2, line=2, cex=cex_labels)
    mtext(text=expression(Viral~population~growth~rate~(hour^-1)),
          side=1, line=2, cex=cex_labels)
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.d[2] - ylim.d[1]) + ylim.d[1], 
         labels="D", cex=cex, font=2)
    
  }
}
dev.off()
```

We again plot delay vs. virus and dose and delay vs. viral population growth rate using
the non-conservative measure of pre-symptomatic transmission (shedding onset
minus symptom onset). We also plot shedding and symptom onset against viral
population growth rate.
```{r, fig.height = 6, fig.width = 3.5}
tiff('Figure S5.tiff', res=500, 
     height=6.5, width=3.5, unit='in')

{
  par(mfrow=c(4, 1), oma=c(1, 2, 0.5, 0), mai=c(0.3, 0.5, 0.3, 0.1))
  
  # Panel A: Delay between symptom onset and shedding onset
  {  
    ylim.ab <- c(floor(min(measures.combined$symptomsToStartShedding, na.rm=T))-1, 
                 ceiling(max(measures.combined$symptomsToStartShedding, na.rm=T))+1)
    
    plot(symptomsToStartShedding ~ jitter(ifelse(pathogen == 'Norovirus', 
                                          ifelse(dose == 4.8, .73,
                                                 ifelse(dose == 48, 1.067, 1.4)),
                                     2), 1.5), 
         data=measures.combined,
         col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         xlim=c(.4, 2.6),
         ylim=ylim.ab, cex.axis=cex, cex=cex.points,
         pch=ifelse(pathogen == 'Norovirus', 
                    ifelse(symptomsToStartShedding < 0, 17, 2),
                    ifelse(symptomsToStartShedding < 0, 23, 5)),
         bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         yaxt="n",
         xaxt="n",
         ylab = "",
         xlab = "",
         mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
      axis(1, at=c(0.73, 1.067, 1.4, 2), 
         labels=c('4.8', '48', '4800', '10'), 
         cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    mtext(text='Norovirus dose\n(RT-PCR units)', side=1, line=3, cex=cex_labels,
          adj=-0.1)
    mtext(text = expression(paste('SARS-CoV-2 dose\n(', TCID[50], ')', sep="")), side=1, 
          line=3, cex=cex_labels, adj=1.05)
    
    axis(2, at=seq(ylim.ab[1],ylim.ab[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
         las=2)
    
    #Average delays per pathogen
    segments(0.63, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$symptomsToStartShedding, 
             0.83,
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$symptomsToStartShedding, 
             col=noro.color,
             lwd=cex)
    
    segments(0.967, 
             noroSummary.dose[noroSummary.dose$dose == 48,]$symptomsToStartShedding, 
             1.167,
             noroSummary.dose[noroSummary.dose$dose == 48,]$symptomsToStartShedding, 
             col=noro.color,
             lwd=cex)
    
    segments(1.3, 
             noroSummary.dose[noroSummary.dose$dose == 4800,]$symptomsToStartShedding, 
             1.5,
             noroSummary.dose[noroSummary.dose$dose == 4800,]$symptomsToStartShedding, 
             col=noro.color,
             lwd=cex)
    
    segments(1.9, sarsSummary.dose$symptomsToStartShedding, 2.1,
             sarsSummary.dose$symptomsToStartShedding, col=sars.color,
             lwd=cex)
  
    #Pre-symptomatic vs post-symptomatic line
    abline(h=0, lty=3, lwd=cex)
    
    # Confidence bounds
     polygon(c(0.63, 0.83, 0.83, 0.63), c(noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToShedLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToShedLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToShedUCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4.8,]
                                         $avgSympToShedUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(0.967, 1.167, 1.167, 0.967), c(noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToShedLCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToShedLCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToShedUCI,
                                             noroSummary.dose[noroSummary.dose$dose == 48,]
                                             $avgSympToShedUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.3, 1.5, 1.5, 1.3), c(noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToShedLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToShedLCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToShedUCI,
                                         noroSummary.dose[noroSummary.dose$dose == 4800,]
                                         $avgSympToShedUCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.9, 2.1, 2.1, 1.9), c(sarsSummary.dose$avgSympToShedLCI,
                                         sarsSummary.dose$avgSympToShedLCI,
                                         sarsSummary.dose$avgSympToShedUCI,
                                         sarsSummary.dose$avgSympToShedUCI),
            col=rgb(86, 179, 233, alpha=100,
                    maxColorValue=255), border = NA)
    
    legend(0.35, 
           -1.5, 
           legend=c("Shedding onset before symptoms", 
                    "Shedding onset on or after symptoms"), 
       pch=c(19, 1, 9), col=c("black", "black", "black"), cex=0.9, bty="n")
    
    text(panellabelratio * 2.2 + .4, panellabelratio * (ylim.ab[2] - ylim.ab[1]) + 
           ylim.ab[1], labels="A", cex=cex, font=2)
  }
    
    # Panel B: Delay between symptom onset and shedding onset vs. viral
    # growth rate
    
  {
    xlim.bcd <- c(-1.25, 0)
      
    plot(symptomsToStartShedding ~ growthRate, data=measures.combined, 
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
      pch=ifelse(pathogen == 'Norovirus', 
                    ifelse(symptomsToStartShedding < 0, 17, 2),
                    ifelse(symptomsToStartShedding < 0, 23, 5)),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       cex=cex.points, cex.axis=cex,
       ylab="", xlab="", xaxt="n", yaxt="n",
       ylim=ylim.ab,
       xlim=xlim.bcd,
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
    bcd.xlabels <- c('',
                     bquote(10^.(-1)),
                     '',
                     bquote(10^.(-0.5)),
                     '',
                     1)
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25),
         labels=do.call(expression, bcd.xlabels),
         cex.axis=cex, 
         mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, at=seq(ylim.ab[1],ylim.ab[2], length.out=5), cex.axis=cex, mgp=c(0, 0.5, 0), tck=-0.04,
         las=2)
    
    # Lines of best fit
    lines(sympToShed ~ growthRate, data=noroSummary.growth, col=noro.color)
  
    lines(sympToShed ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$sympToShedUCI, 
                                                  rev(noroSummary.growth$sympToShedLCI)), 
            col = rgb(135, 26, 110, alpha=100,
                    maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$sympToShedUCI, 
                                                  rev(sarsSummary.growth$sympToShedLCI)), 
            col=rgb(86, 179, 233, alpha=100,
                    maxColorValue=255), border = NA)
    
    abline(h=0, lty=3, lwd=cex)
  
    mtext(text="Day of shedding onset \n minus day of symptom onset",
          side=2, line=3, cex=cex_labels)
  
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1])  + xlim.bcd[1], 
         panellabelratio * (ylim.ab[2] - ylim.ab[1]) + ylim.ab[1], labels="B", 
         cex=cex, font=2)
  }
  
  # Panel C: Shedding onset vs. Viral population growth rate
  
  {
    ylim.c <- c(floor(min(measures.combined$sheddingOnset, na.rm=T)) - 1, 
                ceiling(max(measures.combined$sheddingOnset, na.rm=T)) + 1)
    
    plot(sheddingOnset ~ growthRate, data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
       xlim=xlim.bcd,
       ylim=ylim.c, cex.axis=cex, cex=cex.points,
       pch=ifelse(pathogen == 'Norovirus', 
                    ifelse(symptomsToStartShedding < 0, 17, 2),
                    ifelse(symptomsToStartShedding < 0, 23, 5)),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       xaxt="n", yaxt="n", ylab = "", xlab = "",
       mgp=c(0, 0.5, 0), tck=-0.04, las=2, bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25), 
       labels=do.call(expression, bcd.xlabels),
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    axis(2, at=seq(ylim.c[1],ylim.c[2], by=2), cex.axis=cex, mgp=c(0, 0.5, 0), 
         tck=-0.04, las=2)
    
    # Lines of best fit
    lines(shedding ~ growthRate, data=noroSummary.growth, col=noro.color)
  
    lines(shedding ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$sheddingUCI,
                                                  rev(noroSummary.growth$sheddingLCI)), 
          col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$sheddingUCI,
                                                  rev(sarsSummary.growth$sheddingLCI)), 
            col=rgb(86, 179, 233, alpha=100,
                  maxColorValue=255), border = NA)
    
    mtext(text="Day of \nshedding onset", side=2, line=2, cex=cex_labels)
    
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.c[2] - ylim.c[1]) + ylim.c[1], labels="C", 
         cex=cex, font=2)
  }
    
  # Panel D: Symptom onset vs. Viral population growth rate
  
  {
    ylim.d <- c(floor(min(measures.combined[!measures.combined$ID %in% 
                                                c(noro.unclearpeaks, sars.unclearpeaks),]
                          $incubation, na.rm=T)) - 1, 
              ceiling(max(measures.combined[!measures.combined$ID %in% 
                                                c(noro.unclearpeaks, sars.unclearpeaks),]
                          $incubation, na.rm=T)) + 1)
  
    plot(incubation ~ growthRate, data=measures.combined,
         col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         xlim=xlim.bcd, ylim=ylim.d, cex.axis=cex, cex=cex.points,
         pch=ifelse(pathogen == 'Norovirus', 
                    ifelse(symptomsToStartShedding < 0, 17, 2),
                    ifelse(symptomsToStartShedding < 0, 23, 5)),
         bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
         yaxt="n", xaxt="n", ylab = "", xlab = "", bty='l')
    
    axis(1, at=seq(xlim.bcd[1], xlim.bcd[2], by=0.25), 
       labels=do.call(expression, bcd.xlabels), 
       cex.axis=cex, 
       mgp=c(0, 0.5, 0), tck=-0.04)
    
    axis(2, at=seq(ylim.d[1], ylim.d[2], by=3), cex.axis=cex, mgp=c(0, 0.5, 0), 
         tck=-0.04, las=2)
    
    # Lines of best fit
    lines(symp ~ growthRate, data=noroSummary.growth, col=noro.color)
  
    lines(symp ~ growthRate, data=sarsSummary.growth, col=sars.color)
    
    # Confidence bounds 
    polygon(c(noro.g.range, rev(noro.g.range)), c(noroSummary.growth$sympUCI,
                                                  rev(noroSummary.growth$sympLCI)), 
            col = rgb(135, 26, 110, alpha=100,
                    maxColorValue=255), border = NA)
    
    polygon(c(sars.g.range, rev(sars.g.range)), c(sarsSummary.growth$sympUCI,
                                                  rev(sarsSummary.growth$sympLCI)), 
            col=rgb(86, 179, 233, alpha=100,
                    maxColorValue=255), border = NA)
    
    mtext(text="Day of \nsymptom onset", side=2, line=2, cex=cex_labels)
    mtext(text=expression(Viral~population~growth~rate~(hour^-1)),
          side=1, line=2, cex=cex_labels)
    text(panellabelratio * (xlim.bcd[2] - xlim.bcd[1]) + xlim.bcd[1], 
         panellabelratio * (ylim.d[2] - ylim.d[1]) + ylim.d[1], 
         labels="D", cex=cex, font=2)
    
  }
}

dev.off()
```

We plot: 

* examples of calculating average shedding prior to symptoms and average shedding
over the course of infection
* average shedding prior to symptoms without factoring in sample weights vs. 
day of symptom onset
* average shedding throughout infection vs. duration of infection
* transmission potential prior to symptoms vs. viral population
growth rate
* transmission potential overall vs. viral population growth rate

```{r}
exampleIDs <- c('ID4', 'Throat_5')
noro.example.params <- noro.params[noro.params$ID==exampleIDs[1],]
noro.example.vldata <- noro.FShedData[noro.FShedData$ID==exampleIDs[1],]

sars.example.params <- sars.params[sars.params$ID==exampleIDs[2],]
sars.example.vldata <- sars.TShedData[sars.TShedData$ID==exampleIDs[2],]

panellabelratio <- 0.95

avg.overall.col <- "#8b5e3c"
avg.presymp.col <- "#d89b2c"

tiff('Figure 5.tiff', res=500,
     height=6.5, width=6.5, unit='in')

par(mfrow=c(3, 2), mar=c(3.1, 6, 1.1, 0.15))

{
  
  # Panel A: Norovirus example
  plot.viralload(vldata=noro.FShedData[noro.FShedData$ID==exampleIDs[1],], 
                 pars=unlist(noro.example.params[2:5]),
                 sympdata=noro.example.params, 
                 t.range=noro.endpoints[noro.endpoints$ID==exampleIDs[1],],
                 cex=1, 
                 col=noro.color,
                 pch=noro.pch,
                 cex_labels=0.9,
                 cex.axis=1.1,
                 xmax=30,
                 xlabel="Days after inoculation",
                 xlabel.line=2,
                 x.tick.line=0.75,
                 ylabel="Viral shedding\n(concentration)",
                 ylabel.line=3,
                 y.tick.line=0.7,
                 panellabel="A",
                 example=TRUE)
  
    segments(x0 = -5,
           y0 = noro.example.params$avgSheddingBeforeSymptoms, 
           x1 = noro.example.params$incubation,
           y1 = noro.example.params$avgSheddingBeforeSymptoms,
           col=avg.presymp.col, lty=3, lwd=1.5)
  
  text(8, 
       noro.example.params$avgSheddingBeforeSymptom,
       labels="Average shedding\nbefore symptoms",
       col=avg.presymp.col)
  
  segments(x0 = -5,
           y0 = noro.example.params$avgSheddingOverall, 
           x1 = noro.example.params$sheddingEnd,
           y1 = noro.example.params$avgSheddingOverall,
           col=avg.overall.col, lty=3, lwd=1.5)
  
  text(22, 
       noro.example.params$avgSheddingOverall + 1.5,
       labels="Average shedding\noverall",
       col=avg.overall.col)
  
   # Panel B: SARS-CoV-2 example
  
  plot.viralload(vldata=sars.TShedData[sars.TShedData$ID==exampleIDs[2],], 
                 pars=unlist(sars.example.params[2:5]),
                 sympdata=sars.example.params, 
                 t.range=sars.endpoints[sars.endpoints$ID==exampleIDs[2],],
                 cex=1, 
                 col=sars.color,
                 pch=sars.pch,
                 cex_labels=0.9,
                 cex.axis=1.1,
                 xmax=15,
                 xlabel="Days after inoculation",
                 xlabel.line=2,
                 x.tick.line=0.75,
                 ylabel="",
                 y.tick.line=0.7,
                 panellabel="B",
                 example=TRUE)
  
  segments(x0 = -5,
           y0 = sars.example.params$avgSheddingBeforeSymptoms, 
           x1 = sars.example.params$incubation,
           y1 = sars.example.params$avgSheddingBeforeSymptoms,
           col=avg.presymp.col, lty=3, lwd=1.5)
  
  text(6.5, 
       sars.example.params$avgSheddingBeforeSymptom - 1.25,
       labels="Average shedding\nbefore symptoms", 
       col=avg.presymp.col)
  
  segments(x0 = -5,
           y0 = sars.example.params$avgSheddingOverall, 
           x1 = sars.example.params$sheddingEnd,
           y1 = sars.example.params$avgSheddingOverall,
           col=avg.overall.col, lty=3, lwd=1.5)
  
  text(8.5, 
       sars.example.params$avgSheddingOverall + 3.5,
       labels="Average shedding overall",
       col=avg.overall.col)
  
  # Panel C: Average pre-symptomatic shedding vs. day of symptom onset
  
  xrange <- c(floor(min(measures.combined[
    !is.na(measures.combined$avgSheddingBeforeSymptoms),]$incubation,
                  na.rm=T)) - 1,
              ceiling(max(measures.combined[
    !is.na(measures.combined$avgSheddingBeforeSymptoms),]$incubation,
                  na.rm=T)) + 1)
  yrange <- c(0,
              ceiling(max(measures.combined$avgSheddingBeforeSymptoms,
                  na.rm=T)) + 1)
  
  plot(ifelse(avgSheddingBeforeSymptoms == 0, 0,
              log10(10^avgSheddingBeforeSymptoms+1)) ~ incubation, 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
       pch=ifelse(pathogen == 'Norovirus', 
                    ifelse(symptomsToPeakDay < 0, 17, 2),
                    ifelse(symptomsToPeakDay < 0, 23, 5)),
       ylim=yrange,
       xlim=xrange,
       cex=1,
       ylab = "",
       xlab = "",
       xaxt="n",
       yaxt="n", bty='l')
  
    
  points(ifelse(avgSheddingBeforeSymptoms == 0, 0,
              log10(10^avgSheddingBeforeSymptoms+1)) ~ incubation, 
       data=measures.combined[is.na(measures.combined$symptomsToPeakDay),],
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), cex=0.7, 
       pch=ifelse(pathogen=='Norovirus', 2, 5))

  ylabels <- c(0, 
               bquote(10^2),
               bquote(10^4),
               bquote(10^6))
  
  axis(1, cex.axis=1.2, mgp=c(0, 0.75, 0), tck=-0.04)
  axis(2, at = log10(c(0, 10^seq(2, yrange[2], by=2))+1), 
       labels = do.call(expression, ylabels), 
       las = 2, cex.axis=1.2, mgp=c(0, 0.7, 0), tck=-0.04)
  
  mtext(text="Average shedding\nbefore symptoms",
        side=2, line=3, cex=0.9)
  mtext(text="Day of symptom onset", side=1, line=2, cex=0.9)
  
  # Lines of best fit
  noro.incub.range <- seq(min(noro.params[
    !is.na(noro.params$avgSheddingBeforeSymptoms),]$incubation,
    na.rm=T),
                          max(noro.params[
    !is.na(noro.params$avgSheddingBeforeSymptoms),]$incubation,
    na.rm=T),
                          length=10)
  
  noro.cpred <- data.frame(incubation= noro.incub.range)
  noro.cpred <- transform(noro.cpred, y_predicted = predict(lm.fit.avg.presymp.shedding.duration.noro, 
                                                          newdata=noro.cpred))
  lines(y_predicted ~ incubation, data=noro.cpred, col=noro.color)
  
  sars.incub.range <- seq(min(sars.params[
    !is.na(sars.params$avgSheddingBeforeSymptoms),]
    $incubation, na.rm=T),
                          max(sars.params[
    !is.na(sars.params$avgSheddingBeforeSymptoms),]$
      incubation, na.rm=T),
                          length=10)

  sars.cpred <- data.frame(incubation = sars.incub.range)
  sars.cpred <- transform(sars.cpred, y_predicted = predict(lm.fit.avg.presymp.shedding.duration.sars, 
                                                           newdata=sars.cpred))
  lines(y_predicted ~ incubation, data=sars.cpred, col=sars.color)
  lines(y_predicted-0.05 ~ incubation, data=sars.cpred, col='white')
  
  arrows(x0 = noro.example.params$incubation - 1,
         y0 = noro.example.params$avgSheddingBeforeSymptoms,
         x1 = noro.example.params$incubation - 0.4,
         y1 = noro.example.params$avgSheddingBeforeSymptoms,
         length=0.05)
  
  arrows(x0 = sars.example.params$incubation + 1,
         y0 = sars.example.params$avgSheddingBeforeSymptoms,
         x1 = sars.example.params$incubation + 0.4,
         y1 = sars.example.params$avgSheddingBeforeSymptoms,
         length=0.05)
  
  text(xrange[1] + panellabelratio * (xrange[2] - xrange[1]), 
       panellabelratio * (yrange[2] - yrange[1]) + yrange[1], 
         labels="C", font=2)
  
  # Panel D: Average overall shedding vs. duration of shedding
  
  xrange <- c(floor(min(measures.combined$sheddingEnd)) - 1,
              ceiling(max(measures.combined$sheddingEnd)) + 5)
  yrange <- c(floor(min(measures.combined$avgSheddingOverall)) - 1,
              ceiling(max(measures.combined$avgSheddingOverall)) + 1)

  plot(avgSheddingOverall ~ sheddingEnd, 
       data=measures.combined,
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
      pch=ifelse(pathogen == 'Norovirus', 
                  ifelse(symptomsToPeakDay < 0, 17, 2),
                  ifelse(symptomsToPeakDay < 0, 23, 5)),
       bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color), 
       ylim=yrange,
       xlim=xrange,
       cex=1,
       ylab = "",
       xlab = "",
       xaxt="n",
       yaxt="n", bty='l')
  
  points(avgSheddingOverall ~ sheddingEnd, 
       data=measures.combined[is.na(measures.combined$symptomsToPeakDay),],
       col=ifelse(pathogen == 'Norovirus', noro.color, sars.color), cex=0.7, 
       pch=ifelse(pathogen=='Norovirus', 2, 5))
  
  ylabels <- lapply(seq(yrange[1], yrange[2], by=2), function(x) 
       bquote(10^.(x)))
  axis(1, cex.axis=1.2, mgp=c(0, 0.75, 0), tck=-0.04)
  axis(2, cex.axis=1.2, mgp=c(0, 0.7, 0), tck=-0.04, at=seq(yrange[1], yrange[2], by=2),
       labels=do.call(expression, ylabels),
       las=2)
  
  mtext(text="Average shedding\nthroughout infection",
        side=2, line=3.5, cex=0.9)
  mtext(text="Duration of infection (days)", side=1, line=2,
        cex=0.9)
  
  # Lines of best fit
  noro.infect.dur.range <- seq(min(noro.params$sheddingEnd, na.rm=T),
                          max(noro.params$sheddingEnd, na.rm=T),
                          length=10)
  
  noro.dpred <- data.frame(sheddingEnd= noro.infect.dur.range)
  noro.dpred <- transform(noro.dpred, y_predicted = predict(transmission.avg.fit.noro, 
                                                          newdata=noro.dpred))
  lines(y_predicted ~ sheddingEnd, data=noro.dpred, col=noro.color)
  lines(y_predicted-0.05 ~ sheddingEnd, data=noro.dpred, col='white')
  
  sars.infect.dur.range <- seq(min(sars.params$sheddingEnd, na.rm=T),
                          max(sars.params$sheddingEnd, na.rm=T),
                          length=10)

  sars.dpred <- data.frame(sheddingEnd = sars.infect.dur.range)
  sars.dpred <- transform(sars.dpred, y_predicted = predict(transmission.avg.fit.sars, 
                                                           newdata=sars.dpred))
  lines(y_predicted ~ sheddingEnd, data=sars.dpred, col=sars.color)
  lines(y_predicted-0.1 ~ sheddingEnd, data=sars.dpred, col='white')
  
  arrows(x0 = noro.example.params$sheddingEnd + 5.1,
         y0 = noro.example.params$avgSheddingOverall,
         x1 = noro.example.params$sheddingEnd + 2.25,
         y1 = noro.example.params$avgSheddingOverall,
         length=0.05)
  
  arrows(x0 = sars.example.params$sheddingEnd + 5.1,
         y0 = sars.example.params$avgSheddingOverall,
         x1 = sars.example.params$sheddingEnd + 2.25,
         y1 = sars.example.params$avgSheddingOverall,
         length=0.05)
  
  text(xrange[1] + panellabelratio * (xrange[2] - xrange[1]), 
       panellabelratio * (yrange[2] - yrange[1]) + yrange[1], 
         labels="D", font=2)
  
  legend(17, 4.5, 
         legend=c("Peak shedding before symptoms", "Peak shedding after symptoms",
                  "Unclear peak"), 
     pch=c(19, 1, 1), col=c("black", "black", "black"), pt.cex=c(1, 1, 0.7), bty="n")
  
  # Panel E: Pre-symptomatic transmission potential vs. Viral population growth rate
  
  yrange=c(0,
         ceiling(max(measures.combined$transmissionBeforeSymptoms, na.rm=T)) + 1)
  
  plot(ifelse(transmissionBeforeSymptoms == 0, 0,
              log10(10^transmissionBeforeSymptoms+1)) ~ growthRate, data=measures.combined,
    col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
    bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
   pch=ifelse(pathogen == 'Norovirus', 
                  ifelse(symptomsToPeakDay < 0, 17, 2),
                  ifelse(symptomsToPeakDay < 0, 23, 5)),
    bty='l',
    xaxt='n',
    xlab='',
    xlim=c(-1.25, 0),
    yaxt='n',
    ylab='',
    ylim=yrange
  )
  
  xlabels <- c(bquote(10^.(-1.25)),
               bquote(10^.(-1)),
               bquote(10^.(-0.75)),
               bquote(10^.(-0.5)),
               bquote(10^.(-0.25)),
               1)
  
  ylabels <- c(0, 
               bquote(10^2),
               bquote(10^4),
               bquote(10^6),
               bquote(10^8))
  
  axis(1, at=seq(-1.25, 0, by=0.25),
       labels=do.call(expression, xlabels),
       mgp=c(0, 0.9, 0), tck=-0.04, cex.axis=1.2)
  
  mtext(text=expression(Viral~population~growth~rate~(hour^-1)),
            side=1, line=2.5, cex=0.9)
  
  axis(2, at = log10(c(0, 10^seq(2, yrange[2], 2))+1), 
       labels = do.call(expression, ylabels), 
       las = 2, mgp=c(0, 0.7, 0), tck=-0.04, las=2, cex.axis=1.2)
  
  ylabels <- c(bquote(10^-2),
               bquote(10^0),
               bquote(10^2),
               bquote(10^4),
               bquote(10^6),
               bquote(10^8))
  
  mtext(text='Transmission potential\nprior to symptoms', side=2, line=2.5,
        cex=0.9)
  
   # Lines of best fit
  
  noro.epred <- data.frame(growthRate= noro.g.range)
  noro.epred <- transform(noro.epred, 
                          y_predicted = predict(lm.fit.p2.presymp.transmission.noro,
                                                newdata=noro.epred))
  lines(y_predicted ~ growthRate, data=noro.epred, col=noro.color)
  
  sars.epred <- data.frame(growthRate= sars.g.range)
  sars.epred <- transform(sars.epred, 
                          y_predicted = predict(lm.fit.p2.presymp.transmission.sars,
                                                newdata=sars.epred))
  lines(y_predicted ~ growthRate, data=sars.epred, col=sars.color)
  
  arrows(x0 = noro.example.params$growthRate - 0.12,
         y0 = noro.example.params$transmissionBeforeSymptoms,
         x1 = noro.example.params$growthRate - 0.05,
         y1 = noro.example.params$transmissionBeforeSymptoms,
         length=0.05)
  
  arrows(x0 = sars.example.params$growthRate - 0.12,
         y0 = sars.example.params$transmissionBeforeSymptoms,
         x1 = sars.example.params$growthRate - 0.05,
         y1 = sars.example.params$transmissionBeforeSymptoms,
         length=0.05)
  
  text(-1.25 + panellabelratio * 1.25, 
       panellabelratio * (yrange[2] - yrange[1]) + yrange[1], 
         labels="E", font=2)
  
  # Panel F: Overall transmission potential vs. Viral population growth rate
  
  yrange=c(floor(min(measures.combined$transmissionOverall)) - 1,
         ceiling(max(measures.combined$transmissionOverall)) + 1)
  
  plot(transmissionOverall ~ growthRate, data=measures.combined,
    col=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
    bg=ifelse(pathogen == 'Norovirus', noro.color, sars.color),
   pch=ifelse(pathogen == 'Norovirus', 
                  ifelse(symptomsToPeakDay < 0, 17, 2),
                  ifelse(symptomsToPeakDay < 0, 23, 5)),
    bty='l',
    xaxt='n',
    xlab='',
    xlim=c(-1.25, 0),
    yaxt='n',
    ylab='',
    ylim=yrange
  )
  
  xlabels <- c(bquote(10^.(-1.25)),
               bquote(10^.(-1)),
               bquote(10^.(-0.75)),
               bquote(10^.(-0.5)),
               bquote(10^.(-0.25)),
               1)
  
  axis(1, at=seq(-1.25, 0, by=0.25),
       labels=do.call(expression, xlabels),
       mgp=c(0, 0.9, 0), tck=-0.04, cex.axis=1.2)
  
  mtext(text=expression(Viral~population~growth~rate~(hour^-1)),
            side=1, line=2.5, cex=0.9)
  
  ylabels <- c(bquote(10^3),
               bquote(10^5),
               bquote(10^7),
               bquote(10^9),
               bquote(10^11))
  
  axis(2, at=seq(yrange[1], yrange[2], by=2),
       labels=do.call(expression, ylabels),
       mgp=c(0, 0.7, 0), tck=-0.04, las=2, cex.axis=1.2)
  
  mtext(text='Overall transmission\npotential', side=2, line=3, cex=0.9)
  
  # Lines of best fit
  
  noro.fpred <- data.frame(growthRate= noro.g.range)
  noro.fpred <- transform(noro.fpred, 
                          y_predicted = predict(lm.fit.p2.overall.transmission.noro,
                                                newdata=noro.fpred))
  lines(y_predicted ~ growthRate, data=noro.fpred, col=noro.color)
  lines(y_predicted-0.05 ~ growthRate, data=noro.fpred, col='white')
  
  sars.fpred <- data.frame(growthRate= sars.g.range)
  sars.fpred <- transform(sars.fpred, 
                          y_predicted = predict(lm.fit.p2.overall.transmission.sars,
                                                newdata=sars.fpred))
  lines(y_predicted ~ growthRate, data=sars.fpred, col=sars.color)
  lines(y_predicted-0.05 ~ growthRate, data=sars.fpred, col='white')
  
  arrows(x0 = noro.example.params$growthRate + 0.12,
         y0 = noro.example.params$transmissionOverall,
         x1 = noro.example.params$growthRate + 0.05,
         y1 = noro.example.params$transmissionOverall,
         length=0.05)
  
  arrows(x0 = sars.example.params$growthRate + 0.12,
         y0 = sars.example.params$transmissionOverall,
         x1 = sars.example.params$growthRate + 0.05,
         y1 = sars.example.params$transmissionOverall,
         length=0.05)
  
  text(-1.25 + panellabelratio * 1.25, 
       panellabelratio * (yrange[2] - yrange[1]) + yrange[1], 
         labels="F", font=2)
}

dev.off()

```

We plot average shedding prior to symptoms factoring in sample weights vs. 
incubation period for participants from Ge *et al.*, 2023. Panel A shows an 
example of this calculation.
```{r}
example.first.date <- min(noro.FShedData[noro.FShedData$ID==exampleIDs[1] &
                                           noro.FShedData$days>0, ]$days)

tiff("Figure S4.tiff", res=500, height=6.5,
     width=3.5, unit="in")

{
  {
    par(mfrow=c(2, 1), mai=c(0.7, 0.9, 0.1, 0.1))
    
    plot.viralload(vldata=noro.example.vldata, 
                   pars=unlist(noro.example.params[2:5]),
                   sympdata=noro.example.params, 
                   t.range=noro.endpoints[noro.endpoints$ID==exampleIDs[1],],
                   cex=1, 
                   col=noro.color,
                   pch=noro.pch,
                   cex_labels=0.9,
                   cex.axis=1,
                   xlabel="Days after inoculation",
                   xlabel.line=1.5,
                   x.tick.line=0.5,
                   ylabel="Total viral shedding \n(concentration x sample weight)",
                   ylabel.line=2.5,
                   y.tick.line=0.5,
                   example=TRUE,
                   panellabel="",
                   xmax=2,
                   ylim.lower=5,
                   metric='total_shedding')
    
    segments(x0 = example.first.date,
             y0 = noro.example.params$avgTotalSheddingBeforeSymptoms, 
             x1 = noro.example.params$incubation,
             y1 = noro.example.params$avgTotalSheddingBeforeSymptoms,
             col=avg.presymp.col, lty=3, lwd=1.5)
    text(0.8, noro.example.params$avgTotalSheddingBeforeSymptom + 1,
         labels="Average total shedding\nvalue before symptoms", cex=0.8,
         col=avg.presymp.col)
  
  }
  
  {
    
    xrange <- c(0,
              ceiling(max(noro.params[!is.na(noro.params$avgTotalSheddingBeforeSymptoms),]$
                            incubation,
                  na.rm=T) * 5) / 5)
  
    yrange <- c(0,
                ceiling(max(noro.params$avgTotalSheddingBeforeSymptoms,
                    na.rm=T)) + 1)
  
    plot(ifelse(avgTotalSheddingBeforeSymptoms == 0, 0,
              log10(10^avgTotalSheddingBeforeSymptoms+1)) ~ incubation,
         data=noro.params,
         col=noro.color,
         pch=ifelse(symptomsToPeakDay > 0, 2, 17),
         ylim=yrange,
         xlim=xrange,
         cex=1,
         ylab = "",
         xlab = "",
         xaxt="n",
         yaxt="n", bty='l')
    
    points(ifelse(avgTotalSheddingBeforeSymptoms == 0, 0,
              log10(10^avgTotalSheddingBeforeSymptoms+1)) ~ incubation,
       data=noro.params[is.na(noro.params$symptomsToPeakDay),],
       col=noro.color, cex=0.7, pch=2)
    
    ylabels <- c(0, 
               bquote(10^2),
               bquote(10^4),
               bquote(10^6),
               bquote(10^8))
    
  axis(1, mgp=c(0, 0.5, 0), tck=-0.04)
  
  axis(2, at = log10(c(0, 10^seq(2, yrange[2], by=2))+1), 
       labels = do.call(expression, ylabels), 
       las = 2, mgp=c(0, 0.7, 0), tck=-0.04)
  
    mtext(text="Average total viral shedding \n prior to symptom onset",
          side=2, line=2.5, cex=0.9)
    mtext(text="Day of symptom onset", side=1, line=1.5, cex=0.9)
  
    noro.incub.range <- seq(min(noro.params[
      !is.na(noro.params$avgTotalSheddingBeforeSymptoms),
    ]$incubation,
                                      na.rm=T),
                            max(noro.params[
      !is.na(noro.params$avgTotalSheddingBeforeSymptoms),
    ]$incubation,
                                na.rm=T),
                            length=10)
    # Lines of best fit
    noro.pred <- data.frame(incubation = noro.incub.range)
    noro.pred <- transform(noro.pred, y_predicted = predict(avg.presymp.totalshedding.duration.fit.noro,
                                                            newdata=noro.pred))
    lines(y_predicted ~ incubation, data=noro.pred, col=noro.color)
    
    legend(0, 4, 
         legend=c("Peak shedding after symptoms", "Unclear peak"), 
     pch=c(1, 1), col=c("black", "black"), pt.cex=c(1, 0.7), bty="n",
     cex=0.8)
    
  }
}

dev.off()
```

We plot viral population growth rate (p2), time of peak viral load, and time
of symptom onset against dose for the norovirus study participants.
```{r}
cex <- 1.2
cex_labels <- 0.9

tiff('Figure S3.tiff', res=500,
     width=3.5, height=6.5, unit='in')
{
  par(mfrow=c(3, 1), oma=c(4, 4.5, 0.5, 0), mai=c(0.2, 0.3, 0.2, 0))
  
  # Viral population growth rate vs. dose
  {
   
    yrange <- c(floor(min(noro.params$growthRate, na.rm=T)) - 1,
                ceiling(max(noro.params$growthRate, na.rm=T)) + 1)
  
    ylabels <- lapply(seq(yrange[1], yrange[2], length.out=5), function(x) 
           bquote(10^.(x))) 
    plot(growthRate ~ jitter(ifelse(dose == 4.8, .73,
                     ifelse(dose == 48, 1.067, 
                            ifelse(dose == 4800, 1.4, 0)))), 
       data=noro.params,
       bty='n', ylab="",
       xlab="", col=noro.color,
       xaxt='n', yaxt='n', ylim=yrange, cex=cex,
       xlim=c(0.6, 1.5))
    axis(1, at=c(.73, 1.067, 1.4), labels = c(4.8, 48, 4800), mgp=c(0, 0.75, 0),
         tck=-0.04, cex.axis=cex)
    axis(2, at=seq(yrange[1], yrange[2], length.out=5),
         labels=do.call(expression, ylabels),
         mgp=c(0, 0.75, 0), tck=-0.04, cex.axis=cex, las=2)
    
    segments(.65,
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$growthRate, 
             .81, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$growthRate,
             col=noro.color)
    segments(0.987,
             noroSummary.dose[noroSummary.dose$dose == 48,]$growthRate, 
             1.147, 
             noroSummary.dose[noroSummary.dose$dose == 48,]$growthRate,
             col=noro.color)
    segments(1.32,
             noroSummary.dose[noroSummary.dose$dose == 4800,]$growthRate, 
             1.48, 
             noroSummary.dose[noroSummary.dose$dose == 4800,]$growthRate,
             col=noro.color)
    mtext(text=expression(atop(Viral~population, growth~rate~(hour^-1))), side=2, line=3.5,
          cex=cex_labels)
    
    text(panellabelratio * 2.1 + 0.6, 
         panellabelratio * (yrange[2] - yrange[1]) + yrange[1], labels="A", cex=cex, 
         font=2)
    
    # Confidence bounds
    polygon(c(.65, .81, .81, .65), c(noroSummary.dose[noroSummary.dose$dose==4.8,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avggrowthRateLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avggrowthRateLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(.987, 1.147, 1.147, .987), c(noroSummary.dose[noroSummary.dose$dose==48,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avggrowthRateLCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avggrowthRateLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.32, 1.48, 1.48, 1.32), c(noroSummary.dose[noroSummary.dose$dose==4800,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avggrowthRateUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avggrowthRateLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avggrowthRateLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
  }
  
  # Time of peak viral load vs. dose
  
  {
   
    yrange <- c(floor(min(noro.params$peakDay, na.rm=T)) - 1,
                ceiling(max(noro.params$peakDay, na.rm=T)) + 1)
  
    plot(peakDay ~ jitter(ifelse(dose == 4.8, .73,
                          ifelse(dose == 48, 1.067, 
                            ifelse(dose == 4800, 1.4, 0)))), 
       data=noro.params,
       bty='n', ylab="",
       xlab="", col=noro.color, yaxt='n',
       xaxt='n', ylim=yrange, cex.axis=cex, cex=cex,
       xlim=c(0.6, 1.5))
    axis(2, las=2, cex.axis=cex)
    axis(1, at=c(.73, 1.067, 1.4), labels = c(4.8, 48, 4800), mgp=c(0, 0.75, 0),
         tck=-0.04, cex.axis=cex)
     segments(.65,
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$peakDay,
             .81, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$peakDay,
             col=noro.color)
    segments(.987,
             noroSummary.dose[noroSummary.dose$dose == 48,]$peakDay,
             1.147, 
             noroSummary.dose[noroSummary.dose$dose == 48,]$peakDay,
             col=noro.color)
    segments(1.32,
             noroSummary.dose[noroSummary.dose$dose == 4800,]$peakDay, 
             1.48, 
             noroSummary.dose[noroSummary.dose$dose == 4800,]$peakDay,
             col=noro.color)
    mtext(text="Day of peak shedding", side=2, line=3.5, cex=cex_labels)
    
    text(panellabelratio * 2.1 + 0.6, 
         panellabelratio * (yrange[2] - yrange[1]) + yrange[1], labels="B", cex=cex, 
         font=2)
    
    # Confidence bounds
    polygon(c(.65, .81, .81, .65), c(noroSummary.dose[noroSummary.dose$dose==4.8,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgPeakDayLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgPeakDayLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(.987, 1.147, 1.147, .987), c(noroSummary.dose[noroSummary.dose$dose==48,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgPeakDayLCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgPeakDayLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.32, 1.48, 1.48, 1.32), c(noroSummary.dose[noroSummary.dose$dose==4800,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgPeakDayUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgPeakDayLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgPeakDayLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
  }
  
  # Time of symptom onset vs. dose
  
  {
   
    yrange <- c(0,
                ceiling(max(noro.params$incubation)) + 1)
  
    plot(incubation ~ jitter(ifelse(dose == 4.8, .73,
                          ifelse(dose == 48, 1.067, 
                            ifelse(dose == 4800, 1.4, 0)))), 
       data=noro.params,
       bty='n', ylab="",
       xlab="", col=noro.color,
       xaxt='n', ylim=yrange, yaxt='n',
       cex.axis=cex, cex=cex,
       xlim=c(0.6, 1.5))
    axis(2, las=2, cex.axis=cex)
    axis(1, at=c(.73, 1.067, 1.4), labels = c(4.8, 48, 4800), mgp=c(0, 0.75, 0),
         tck=-0.04, cex.axis=cex)
    
       segments(.65,
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$incubation, 
             .81, 
             noroSummary.dose[noroSummary.dose$dose == 4.8,]$incubation,
             col=noro.color)
       segments(.987,
             noroSummary.dose[noroSummary.dose$dose == 48,]$incubation, 
             1.147, 
             noroSummary.dose[noroSummary.dose$dose == 48,]$incubation,
             col=noro.color)
    segments(1.32,
             noroSummary.dose[noroSummary.dose$dose == 4800,]$incubation, 
             1.48, 
             noroSummary.dose[noroSummary.dose$dose == 4800,]$incubation,
             col=noro.color)
    
    mtext(text="Day of symptom onset", side=2, line=3.5, cex=cex_labels)
    mtext(text="Infectious dose\n(norovirus, RT-PCR units)", side=1, line=3.5,
          cex=cex_labels)
    
    text(panellabelratio * 2.1 + 0.6, 
         panellabelratio * (yrange[2] - yrange[1]) + yrange[1], labels="C", cex=cex, 
         font=2)
    
    # Confidence bounds
    polygon(c(.65, .81, .81, .65), c(noroSummary.dose[noroSummary.dose$dose==4.8,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgIncubLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4.8,]$avgIncubLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(.987, 1.147, 1.147, .987), c(noroSummary.dose[noroSummary.dose$dose==48,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgIncubLCI,
                                     noroSummary.dose[noroSummary.dose$dose==48,]$avgIncubLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
    polygon(c(1.32, 1.48, 1.48, 1.32), c(noroSummary.dose[noroSummary.dose$dose==4800,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgIncubUCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgIncubLCI,
                                     noroSummary.dose[noroSummary.dose$dose==4800,]$avgIncubLCI),
            col=rgb(135, 26, 110, alpha=100,
                  maxColorValue=255), border = NA)
    
  }
}
dev.off()
```

Lastly, for clarification, we plot the differences in incubation periods reported in 
Ge *et al.*, 2023 and Atmar *et al.*, 2008.
```{r}
atmarVals <- read.csv(here("data", "Atmar incubation periods.csv"))

geVals <- do.call(rbind, 
                  lapply(noroParticipants,
                         function(x) data.frame(
                           geID=x,
                           dose=unique(noro.FShedData[noro.FShedData$ID == x,]$dose),
                           geIncubation=noro.params[noro.params$ID == x,]$incubation,
                           peakDay=noro.params[noro.params$ID == x,]$peakDay)))

comparisonVals <- merge(geVals, matches, by = 'geID')

comparisonVals <- merge(comparisonVals, atmarVals[, c('atmarID', 'atmarIncubation')], by='atmarID')

comparisonVals <- comparisonVals[!is.na(comparisonVals$peakDay),]

# Ordering by geID
comparisonVals <- comparisonVals[order(as.numeric(substring(comparisonVals$geID, 3, 4))),]

atmarColor <- "#f1a340"
geColor <- "#871a6e"

tiff('Figure S2.tiff', res=500, width=6.5, height=3.5, unit='in')
{
  par(mar=c(4.1, 3.6, 0.5, 0.1), oma=c(2, 0, 0, 0))
  plot(1:nrow(comparisonVals), comparisonVals$atmarIncubation, xaxt="n",
       ylim=c(0, 5), col=atmarColor, xlab="", ylab="",
       bty="n")
  axis(1, at=1:nrow(comparisonVals), 
       labels=comparisonVals$geID,las=2, col.axis=geColor)
  axis(1, at=1:(nrow(comparisonVals)), 
       labels=paste(comparisonVals$atmarID, ' /        ', sep=''), las=2, 
       col.axis=atmarColor)
  mtext("Participant ID", side=1, line=5)
  mtext("Day", side=2, line=2.5)
  legend(4.5, 5, pch=c(1, 1, 16), col=c(atmarColor, geColor, 'black'), 
         legend=c(bquote("Atmar" ~ italic("et al.") ~ 2008 ~ "\u2014 symptom onset"), 
                  bquote("Ge" ~ italic("et al.") ~ 2023 ~ "\u2014 symptom onset"),
                  "Peak viral shedding"))
  points(1:nrow(comparisonVals), comparisonVals$geIncubation, col=geColor)
  points(1:nrow(comparisonVals), comparisonVals$peakDay, pch=16)
}
dev.off()
```
